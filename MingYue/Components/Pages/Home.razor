@page "/"
@using MingYue.Models
@using MingYue.Services
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject ISystemMonitorService SystemMonitorService
@inject IApplicationService ApplicationService
@inject IDockItemService DockItemService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>MingYue - Home Server Portal</PageTitle>

<!-- Main Content Container -->
<FluentStack Orientation="Orientation.Vertical" Class="home-content">
    <!-- Clock Section -->
    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" Class="home-clock-section">
        <div class="home-clock">@TimeNow</div>
        <FluentLabel Typo="Typography.Body" Class="home-date">@DateNow</FluentLabel>
    </FluentStack>
    <!-- Info Cards -->
    <FluentGrid Justify="JustifyContent.Center" Class="home-info-cards" Style="width:100%">
        <FluentGridItem sm="4" xs="12">
            <!-- Weather Card -->
            <FluentCard Class="info-card info-card-weather">
                <div class="info-card-glow weather-glow"></div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                        <FluentLabel Typo="Typography.Body" Class="info-card-label">天气</FluentLabel>
                        <div class="info-card-icon weather-icon">
                            <FluentIcon Value="@(new Icons.Regular.Size24.WeatherSunny())" Color="Color.Custom" CustomColor="#facc15" />
                        </div>
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <div class="weather-temp">18°</div>
                        <FluentLabel Typo="Typography.Body" Class="weather-condition">晴朗</FluentLabel>
                        <FluentLabel Typo="Typography.Body" Class="weather-range">最高 22° / 最低 14°</FluentLabel>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
        <FluentGridItem sm="4" xs="12">
            <!-- System Monitor Card -->
            <FluentCard Class="info-card info-card-system">
                <div class="info-card-glow system-glow"></div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                        <FluentLabel Typo="Typography.Body" Class="info-card-label">系统监控</FluentLabel>
                        <FluentIcon Value="@(new Icons.Regular.Size20.Server())" />
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="6">
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                                <FluentLabel Typo="Typography.Body" Class="stat-label">CPU</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Class="stat-value-cyan">@systemInfo.Cpu.UsagePercent.ToString("F0")%</FluentLabel>
                            </FluentStack>
                            <FluentProgress Min="0" Max="100" Value="@((int)systemInfo.Cpu.UsagePercent)" Class="progress-bar-cyan" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="6">
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                                <FluentLabel Typo="Typography.Body" Class="stat-label">RAM</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Class="stat-value-purple">@systemInfo.Memory.UsedGB</FluentLabel>
                            </FluentStack>
                            <FluentProgress Min="0" Max="100" Value="@((int)systemInfo.Memory.UsagePercent)" Class="progress-bar-purple" />
                        </FluentStack>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
        <FluentGridItem sm="4" xs="12">
            <!-- Network Status Card -->
            <FluentCard Class="info-card info-card-network">
                <div class="info-card-glow network-glow"></div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                        <FluentLabel Typo="Typography.Body" Class="info-card-label">网络状态</FluentLabel>
                        <div class="network-indicator"></div>
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="16">
                        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="4" Class="network-stat-item">
                            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowDownload())" Color="Color.Custom" CustomColor="#22c55e" />
                            <FluentLabel Typo="Typography.Body">@downloadSpeed</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Class="network-stat-unit">MB/S</FluentLabel>
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="4" Class="network-stat-item">
                            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowUpload())" Color="Color.Custom" CustomColor="#60a5fa" />
                            <FluentLabel Typo="Typography.Body">@uploadSpeed</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Class="network-stat-unit">MB/S</FluentLabel>
                        </FluentStack>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
    </FluentGrid>

    <FluentStack Orientation="Orientation.Vertical" VerticalGap="24" Class="home-applications">
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Class="home-section-header">
            <FluentLabel Typo="Typography.Header" Class="home-section-title">应用程序</FluentLabel>
            <FluentAnchor Href="/app-management" Appearance="Appearance.Lightweight" Class="view-all-link">查看全部</FluentAnchor>
        </FluentStack>
        <div class="app-grid">
            @foreach (var app in visibleApplications)
            {
                <FluentCard Class="app-card" @onclick="@(() => Navigation.NavigateTo(app.Url, true))">
                    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="12">
                        <div class="app-icon" style="background: @GetAppGradient(app.IconColor)">
                            @if (!string.IsNullOrEmpty(app.Icon))
                            {
                                <FluentIcon Value="@GetIcon(app.Icon)" />
                            }
                            else
                            {
                                <FluentIcon Value="@(new Icons.Regular.Size24.Apps())" />
                            }
                        </div>
                        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="2" Class="app-info">
                            <FluentLabel Typo="Typography.Body" Class="app-title">@app.Title</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Class="app-category">@app.Category</FluentLabel>
                        </FluentStack>
                    </FluentStack>
                </FluentCard>
            }
            <FluentCard Class="app-card app-card-add" @onclick="@(() => Navigation.NavigateTo("/app-management"))">
                <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="12">
                    <div class="app-icon app-icon-add">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Add())" />
                    </div>
                    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" Class="app-info">
                        <FluentLabel Typo="Typography.Body" Class="app-title">添加</FluentLabel>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </div>
    </FluentStack>
</FluentStack>

<!-- Bottom Dock -->
<FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center" HorizontalGap="8" Class="home-dock">
    @foreach (var item in dockItems.Take(4))
    {
        <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" Class="dock-item"
                      @onclick="@(() => Navigation.NavigateTo(item.Url))"
                      title="@item.Title">
            @if (!string.IsNullOrEmpty(item.Icon))
            {
                <FluentIcon Value="@GetIcon(item.Icon)" />
            }
            else
            {
                <FluentIcon Value="@(new Icons.Regular.Size24.Apps())" />
            }
            <FluentTooltip Anchor="@item.ItemId" Position="TooltipPosition.Top">@item.Title</FluentTooltip>
        </FluentButton>
    }
</FluentStack>


@code {
    private string TimeNow => DateTime.Now.ToString("HH:mm");
    private string DateNow => DateTime.Now.ToString("yyyy年MM月dd日, 星期") + GetDayOfWeek();
    private SystemResourceInfo systemInfo = new();
    private List<Application> visibleApplications = new();
    private List<DockItem> dockItems = new();
    private System.Threading.Timer? updateTimer;
    private int downloadSpeed = 24;
    private int uploadSpeed = 12;
    private static readonly Random _random = new Random();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();

        // Update time and system info every 3 seconds
        updateTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadSystemInfoAsync();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private async Task LoadDataAsync()
    {
        await Task.WhenAll(
            LoadSystemInfoAsync(),
            LoadApplicationsAsync(),
            LoadDockItemsAsync()
        );
    }

    private async Task LoadSystemInfoAsync()
    {
        try
        {
            systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();

            // TODO: Implement proper network speed calculation with delta between time intervals
            // This is placeholder logic for demonstration purposes
            if (systemInfo.Networks.Any())
            {
                var mainNetwork = systemInfo.Networks.First();
                downloadSpeed = (int)(mainNetwork.BytesReceived / 1024.0 / 1024.0 % 100);
                uploadSpeed = (int)(mainNetwork.BytesSent / 1024.0 / 1024.0 % 100);
            }
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private async Task LoadApplicationsAsync()
    {
        try
        {
            var allApps = await ApplicationService.GetAllApplicationsAsync();
            visibleApplications = allApps.Where(a => a.IsVisible).Take(8).ToList();
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private async Task LoadDockItemsAsync()
    {
        try
        {
            dockItems = await DockItemService.GetAllDockItemsAsync();
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private string GetDayOfWeek()
    {
        return DateTime.Now.DayOfWeek switch
        {
            DayOfWeek.Monday => "一",
            DayOfWeek.Tuesday => "二",
            DayOfWeek.Wednesday => "三",
            DayOfWeek.Thursday => "四",
            DayOfWeek.Friday => "五",
            DayOfWeek.Saturday => "六",
            DayOfWeek.Sunday => "日",
            _ => ""
        };
    }

    private string GetAppGradient(string? iconColor)
    {
        if (string.IsNullOrEmpty(iconColor))
        {
            // Default gradients for variety
            var gradients = new[]
            {
                "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
                "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",
                "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
                "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)"
            };
            return gradients[_random.Next(gradients.Length)];
        }
        return $"linear-gradient(135deg, {iconColor} 0%, {iconColor}dd 100%)";
    }

    private Icon GetIcon(string iconName)
    {
        // TODO: Implement icon mapping based on iconName parameter
        // For now, return default icon - icon mapping can be added based on application requirements
        return new Icons.Regular.Size24.Apps();
    }

    public void Dispose()
    {
        updateTimer?.Dispose();
    }
}