@inherits LayoutComponentBase
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@using MingYue.Components.Dialog
@using MingYue.Components.Shared
@using MingYue.Models
@using MingYue.Services
@using MingYue.Resources
@using Microsoft.Extensions.Localization
@inject IDialogService DialogService
@inject AuthenticationStateService AuthStateService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResources> Localizer
@implements IDisposable

<FluentDesignTheme @bind-Mode="@Settings.Mode" @bind-OfficeColor="@Settings.OfficeColor" StorageName="theme" />
<!-- Background Effects -->
<div class="home-bg-effects">
    <div class="bg-gradient-blob bg-gradient-blob-1"></div>
    <div class="bg-gradient-blob bg-gradient-blob-2"></div>
    <div class="bg-gradient-blob bg-gradient-blob-3"></div>
    <div class="bg-grid-pattern"></div>
</div>
<!-- Standard layout for other pages -->
<FluentLayout>
    <!-- Header -->
    <div class="home-header">
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center" HorizontalGap="16">
                <div class="home-logo" @onclick="@(() => Navigation.NavigateTo("/"))" style="cursor: pointer;">
                    <FluentIcon Value="@(new Icons.Regular.Size24.GridDots())" Color="Color.Accent" />
                </div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="0" @onclick="@(() => Navigation.NavigateTo("/"))" style="cursor: pointer;">
                    <FluentLabel Typo="Typography.Body" Class="home-title-main">MingYue</FluentLabel>
                    <FluentLabel Typo="Typography.Body" Class="home-title-sub">Home Server</FluentLabel>
                </FluentStack>

                <FluentSpacer></FluentSpacer>

                <!-- Management Menu -->
                <FluentMenuButton Text="@Localizer["Management"]" Appearance="Appearance.Lightweight">
                    <FluentMenuItem OnClick="@(() => Navigation.NavigateTo("/file-manager"))">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Folder())" Slot="start" />
                        @Localizer["FileManager"]
                    </FluentMenuItem>
                    <FluentMenuItem OnClick="@(() => Navigation.NavigateTo("/docker"))">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Box())" Slot="start" />
                        @Localizer["DockerManagement"]
                    </FluentMenuItem>
                    <FluentMenuItem OnClick="@(() => Navigation.NavigateTo("/disk-management"))">
                        <FluentIcon Value="@(new Icons.Regular.Size16.HardDrive())" Slot="start" />
                        @Localizer["DiskManagement"]
                    </FluentMenuItem>
                    <FluentMenuItem OnClick="@(() => Navigation.NavigateTo("/share-management"))">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Share())" Slot="start" />
                        @Localizer["ShareManagement"]
                    </FluentMenuItem>
                    <FluentMenuItem OnClick="@(() => Navigation.NavigateTo("/app-management"))">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Apps())" Slot="start" />
                        @Localizer["ApplicationManagement"]
                    </FluentMenuItem>
                    <FluentMenuItem OnClick="@(() => Navigation.NavigateTo("/dock-management"))">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Box())" Slot="start" />
                        @Localizer["DockManagement"]
                    </FluentMenuItem>
                    @if (AuthStateService.IsAdmin)
                    {
                        <FluentMenuItem OnClick="@(() => Navigation.NavigateTo("/user-management"))">
                            <FluentIcon Value="@(new Icons.Regular.Size16.People())" Slot="start" />
                            @Localizer["UserManagement"]
                        </FluentMenuItem>
                    }
                </FluentMenuButton>

                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/scheduled-tasks"))" Title="@Localizer["ScheduledTasks"]">
                    <FluentIcon Value="@(new Icons.Regular.Size20.CalendarClock())"></FluentIcon>
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/anydrop"))" Title="@Localizer["Anydrop"]">
                    <FluentIcon Value="@(new Icons.Regular.Size20.ShareAndroid())"></FluentIcon>
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/network"))" Title="@Localizer["Network"]">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Wifi1())"></FluentIcon>
                </FluentButton>
                <!-- Notification Button with Badge -->
                <FluentCounterBadge Count="unreadCount" Appearance="Appearance.Lightweight" @onclick="OpenNotificationPanel">
                    <FluentButton Appearance="Appearance.Lightweight">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Alert())" />
                    </FluentButton>
                </FluentCounterBadge>
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/settings"))" Title="@Localizer["Settings"]">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Settings())" />
                </FluentButton>
                @if (AuthStateService.IsAuthenticated && AuthStateService.CurrentUser != null)
                {
                    <FluentProfileMenu FullName="@AuthStateService.CurrentUser.Username"
                                       Style="--fluent-profile-menu-hover: var(--neutral-stroke-focus); padding: 4px;">
                        <StartTemplate>
                            @AuthStateService.CurrentUser.Username
                        </StartTemplate>
                        <HeaderTemplate>
                            <FluentStack Orientation="Orientation.Horizontal">
                                <FluentSpacer></FluentSpacer>
                                <FluentButton Appearance="Appearance.Lightweight" OnClick="Logout" Title="Logout" IconStart="@(new Icons.Regular.Size20.SignOut())">
                                    Sign Out
                                </FluentButton>
                            </FluentStack>
                        </HeaderTemplate>
                        <ChildContent>
                            <div style="width: 250px; height: 80px">
                                <FluentLabel Typo="@Typography.Header" Style="font-weight: bold;">@AuthStateService.CurrentUser.Username</FluentLabel>
                                @if (AuthStateService.IsAdmin)
                                {
                                    <FluentBadge Fill="success" BackgroundColor="green" Color="white">Admin</FluentBadge>
                                }
                            </div>
                        </ChildContent>
                        <FooterTemplate>
                            <FluentStack>
                                <FluentSpacer />
                                <FluentAnchor Appearance="@Appearance.Hypertext"
                                              Href="https://microsoft.com"
                                              Target="_blank">Account</FluentAnchor>
                            </FluentStack>
                        </FooterTemplate>
                    </FluentProfileMenu>
                }
            </FluentStack>
        </FluentStack>
    </div>
    <div class="home-content">
        @Body
    </div>
</FluentLayout>

<FluentToastProvider />
<FluentDialogProvider />
<FluentTooltipProvider />
<FluentMessageBarProvider />
<FluentMenuProvider />
<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    public SettingModel Settings { get; set; } = new();
    private string _currentPath = "";
    private int unreadCount = 0;
    private readonly SemaphoreSlim _updateUnreadCountSemaphore = new(1, 1);

    protected override async Task OnInitializedAsync()
    {
        AuthStateService.OnAuthenticationStateChanged += StateHasChanged;
        Navigation.LocationChanged += OnLocationChanged;
        NotificationService.NotificationsChanged += OnNotificationsChanged;
        UpdateCurrentPath();
        await UpdateUnreadCountAsync();
    }

    private async void OnNotificationsChanged(object? sender, EventArgs e)
    {
        await UpdateUnreadCountAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateUnreadCountAsync()
    {
        await _updateUnreadCountSemaphore.WaitAsync();
        try
        {
            unreadCount = await NotificationService.GetUnreadCountAsync();
        }
        finally
        {
            _updateUnreadCountSemaphore.Release();
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateCurrentPath();
        StateHasChanged();
    }

    private void UpdateCurrentPath()
    {
        _currentPath = Navigation.ToBaseRelativePath(Navigation.Uri);
    }

    public async Task OpenNotificationPanel()
    {
        var dialog = await DialogService.ShowPanelAsync<NotificationPanel>(new DialogParameters()
        {
            Alignment = HorizontalAlignment.Right,
            Title = Localizer["Notifications"],
            PrimaryAction = null,
            SecondaryAction = null,
        });
        await dialog.Result;
    }

    public async Task OpenSetting()
    {
        IDialogReference? _dialog;
        _dialog = await DialogService.ShowPanelAsync<SettingDialog>(Settings, new DialogParameters<SettingModel>()
        {
            Content = Settings,
            Alignment = HorizontalAlignment.Right,
            Title = $"Hello",
        });
        _ = await _dialog.Result;
        // HandlePanel(result);
    }

    private async Task Logout()
    {
        await AuthStateService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    public void Dispose()
    {
        AuthStateService.OnAuthenticationStateChanged -= StateHasChanged;
        Navigation.LocationChanged -= OnLocationChanged;
        NotificationService.NotificationsChanged -= OnNotificationsChanged;
        _updateUnreadCountSemaphore?.Dispose();
    }
}
