@page "/login"
@using MingYue.Models
@using MingYue.Services
@using MingYue.Resources
@using Microsoft.Extensions.Localization
@inject IAuthenticationService AuthService
@inject AuthenticationStateService AuthStateService
@inject NavigationManager Navigation
@inject ILogger<Login> Logger
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["Login"] - MingYue</PageTitle>

<div class="login-container">
    <FluentCard Class="login-card">
        <div class="login-header">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.LockClosed())" Color="@Color.Accent" />
            <h2>@Localizer["WelcomeToMingYue"]</h2>
            <p>@Localizer["PleaseSignInToContinue"]</p>
        </div>

        <EditForm Model="@loginRequest" OnValidSubmit="@HandleLogin" FormName="login">
            <DataAnnotationsValidator />
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
                <FluentTextField 
                    @bind-Value="loginRequest.Username"
                    Label="@Localizer["Username"]"
                    Placeholder="@Localizer["EnterYourUsername"]"
                    Required="true"
                    Style="width: 100%;" />
                <ValidationMessage For="@(() => loginRequest.Username)" />

                <FluentTextField 
                    @bind-Value="loginRequest.Password"
                    Label="@Localizer["Password"]"
                    Placeholder="@Localizer["EnterYourPassword"]"
                    TextFieldType="TextFieldType.Password"
                    Required="true"
                    Style="width: 100%;" />
                <ValidationMessage For="@(() => loginRequest.Password)" />

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <FluentMessageBar Intent="MessageIntent.Error">
                        @errorMessage
                    </FluentMessageBar>
                }

                <FluentButton 
                    Type="ButtonType.Submit"
                    Appearance="Appearance.Accent"
                    Loading="@isLoading"
                    Style="width: 100%;">
                    @Localizer["SignIn"]
                </FluentButton>
            </FluentStack>
        </EditForm>

        <FluentDivider Style="margin: 20px 0;" />

        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
            <p style="text-align: center; color: var(--neutral-foreground-rest);">
                @Localizer["DontHaveAccount"]
            </p>
            <FluentButton 
                Appearance="Appearance.Outline"
                OnClick="@NavigateToSetup"
                Style="width: 100%;">
                @Localizer["InitialSetup"]
            </FluentButton>
        </FluentStack>
    </FluentCard>
</div>



@code {
    private readonly LoginRequest loginRequest = new();
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if already authenticated
        if (AuthStateService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        // Try to restore session
        var restored = await AuthStateService.TryRestoreSessionAsync();
        if (restored)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        errorMessage = string.Empty;
        isLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(loginRequest);

            if (response.Success && response.User != null)
            {
                await AuthStateService.SetCurrentUserAsync(response.User);
                Logger.LogInformation("User {Username} logged in successfully", response.User.Username);
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = response.Message;
                Logger.LogWarning("Login failed: {Message}", response.Message);
            }
        }
        catch (Exception ex)
        {
            errorMessage = Localizer["LoginError"];
            Logger.LogError(ex, "Login error");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToSetup()
    {
        Navigation.NavigateTo("/initial-setup");
    }
}
