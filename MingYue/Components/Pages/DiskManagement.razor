@page "/disk-management-new"
@using MingYue.Models
@using MingYue.Services
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject IDiskManagementService DiskService
@inject IShareManagementService ShareService
@inject AuthenticationStateService AuthStateService
@inject NavigationManager Navigation
@inject ILogger<DiskManagement> Logger
@inject IToastService ToastService

<PageTitle>磁盘与共享管理 - MingYue</PageTitle>

@if (!isAuthorized)
{
    <FluentMessageBar Intent="MessageIntent.Error">
        <p>访问被拒绝。您必须是管理员才能访问此页面。</p>
    </FluentMessageBar>
    return;
}

<FluentStack Orientation="Orientation.Vertical" VerticalGap="24" Style="padding: 24px;">
    <!-- Page Header -->
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
            <h1 style="margin: 0; font-size: 32px; font-weight: 600;">磁盘与共享管理</h1>
            <FluentSpacer />
            <FluentButton Appearance="Appearance.Lightweight" OnClick="@RefreshAll">
                <FluentIcon Value="@(new Icons.Regular.Size20.ArrowSync())" />
                刷新状态
            </FluentButton>
            <FluentButton Appearance="Appearance.Accent" OnClick="@OpenScanDiskDialog">
                <FluentIcon Value="@(new Icons.Regular.Size20.Search())" />
                重新扫描磁盘
            </FluentButton>
        </FluentStack>
        <FluentLabel Style="color: var(--neutral-foreground-hint); font-size: 14px;">
            管理本地磁盘挂载点及网络文件共享服务状态。
        </FluentLabel>
    </FluentStack>

    @if (isLoading)
    {
        <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 60px 0;">
            <FluentProgressRing />
        </FluentStack>
    }
    else
    {
        <!-- Disk Mount Management Section -->
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                <FluentIcon Value="@(new Icons.Regular.Size24.HardDrive())" Style="font-size: 20px;" />
                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">磁盘挂载管理</h2>
            </FluentStack>

            <FluentCard Style="padding: 0; background: var(--neutral-layer-2);">
                @if (allDisks.Count == 0)
                {
                    <div style="padding: 40px; text-align: center; color: var(--neutral-foreground-hint);">
                        <FluentIcon Value="@(new Icons.Regular.Size48.HardDrive())" Style="font-size: 48px; opacity: 0.5;" />
                        <div style="margin-top: 12px;">未发现磁盘</div>
                    </div>
                }
                else
                {
                    <FluentDataGrid Items="@allDisks.AsQueryable()" 
                                  GridTemplateColumns="2fr 1.5fr 0.8fr 0.8fr 1.5fr 0.8fr 1fr"
                                  Style="width: 100%;">
                        <!-- Disk Name & Info -->
                        <TemplateColumn Title="磁盘信息">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                <FluentLabel Style="font-weight: 600;">@GetDiskDisplayName(context)</FluentLabel>
                                <FluentLabel Style="font-size: 12px; color: var(--neutral-foreground-hint);">
                                    @context.DevicePath @(!string.IsNullOrEmpty(context.Model) ? $"({context.SizeDisplay})" : "")
                                </FluentLabel>
                            </FluentStack>
                        </TemplateColumn>

                        <!-- File System -->
                        <TemplateColumn Title="文件系统">
                            @if (!string.IsNullOrEmpty(context.FileSystem))
                            {
                                <FluentBadge Appearance="Appearance.Neutral" Style="background: var(--neutral-layer-4);">
                                    @context.FileSystem
                                </FluentBadge>
                            }
                            else
                            {
                                <span style="color: var(--neutral-foreground-hint);">--</span>
                            }
                        </TemplateColumn>

                        <!-- Mount Point -->
                        <TemplateColumn Title="挂载点">
                            <span style="font-family: monospace; font-size: 13px;">
                                @(string.IsNullOrEmpty(context.MountPoint) ? "--" : context.MountPoint)
                            </span>
                        </TemplateColumn>

                        <!-- Space Usage -->
                        <TemplateColumn Title="空间使用">
                            @if (context.TotalBytes > 0)
                            {
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                    <FluentLabel Style="font-size: 13px;">
                                        @context.UsedGB / @context.TotalGB
                                    </FluentLabel>
                                    <FluentProgress Min="0" Max="100" Value="@((int)context.UsagePercent)" 
                                                  Style="width: 100%;" />
                                    <FluentLabel Style="font-size: 11px; color: var(--neutral-foreground-hint);">
                                        @context.UsagePercent.ToString("F1")%
                                    </FluentLabel>
                                </FluentStack>
                            }
                            else
                            {
                                <span style="color: var(--neutral-foreground-hint);">--</span>
                            }
                        </TemplateColumn>

                        <!-- Status -->
                        <TemplateColumn Title="状态">
                            @if (context.IsReady)
                            {
                                <FluentBadge Fill="success" BackgroundColor="#107c10" Color="white">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.CheckmarkCircle())" Style="margin-right: 4px;" />
                                    已挂载
                                </FluentBadge>
                            }
                            else
                            {
                                <FluentBadge Appearance="Appearance.Neutral" Style="background: var(--neutral-layer-4);">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Circle())" Style="margin-right: 4px;" />
                                    未挂载
                                </FluentBadge>
                            }
                        </TemplateColumn>

                        <!-- Actions -->
                        <TemplateColumn Title="操作">
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4">
                                @if (context.IsReady)
                                {
                                    <FluentButton Appearance="Appearance.Lightweight" 
                                                OnClick="@(() => UnmountDisk(context))"
                                                Title="卸载">
                                        <FluentIcon Value="@(new Icons.Regular.Size16.ArrowExit())" Color="Color.Error" />
                                    </FluentButton>
                                }
                                else if (!string.IsNullOrEmpty(context.DevicePath))
                                {
                                    <FluentButton Appearance="Appearance.Accent" 
                                                OnClick="@(() => MountDisk(context))"
                                                Style="font-size: 13px; padding: 4px 12px;">
                                        挂载
                                    </FluentButton>
                                }
                                <FluentButton Appearance="Appearance.Lightweight" 
                                            OnClick="@(() => OpenDiskSettings(context))"
                                            Title="设置">
                                    <FluentIcon Value="@(new Icons.Regular.Size16.Settings())" />
                                </FluentButton>
                            </FluentStack>
                        </TemplateColumn>
                    </FluentDataGrid>
                }
            </FluentCard>
        </FluentStack>

        <!-- File Share Management Section -->
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                <FluentIcon Value="@(new Icons.Regular.Size24.Folder())" Style="font-size: 20px;" />
                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">文件共享管理</h2>
                <FluentSpacer />
                <FluentButton Appearance="Appearance.Accent" OnClick="@OpenAddShareDialog">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Add())" />
                    添加共享
                </FluentButton>
            </FluentStack>

            @if (shares.Count == 0)
            {
                <FluentCard Style="padding: 40px; text-align: center; background: var(--neutral-layer-2);">
                    <div style="opacity: 0.5; margin-bottom: 40px;">
                        <FluentIcon Value="@(new Icons.Regular.Size48.Add())" Style="font-size: 64px; color: var(--neutral-foreground-hint);" />
                    </div>
                    <FluentButton Appearance="Appearance.Accent" OnClick="@OpenAddShareDialog" Style="font-size: 14px;">
                        <FluentIcon Value="@(new Icons.Regular.Size20.Add())" />
                        添加共享
                    </FluentButton>
                </FluentCard>
            }
            else
            {
                <FluentGrid Spacing="3">
                    @foreach (var share in shares)
                    {
                        <FluentGridItem xs="12" sm="6" md="4">
                            <FluentCard Style="padding: 20px; background: var(--neutral-layer-2); height: 100%;">
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                                    <!-- Share Header -->
                                    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                                        <FluentIcon Value="@GetShareIcon(share)" Style="font-size: 32px; color: var(--accent-fill-rest);" />
                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="2" Style="flex: 1;">
                                            <FluentLabel Style="font-weight: 600; font-size: 16px;">@share.Name</FluentLabel>
                                            <FluentBadge Appearance="Appearance.Neutral" Style="background: var(--neutral-layer-4); width: fit-content;">
                                                @GetShareTypeDisplay(share)
                                            </FluentBadge>
                                        </FluentStack>
                                        <FluentButton Appearance="Appearance.Lightweight" 
                                                    OnClick="@(() => OpenShareMenu(share))"
                                                    Style="min-width: auto;">
                                            <FluentIcon Value="@(new Icons.Regular.Size20.MoreVertical())" />
                                        </FluentButton>
                                    </FluentStack>

                                    <!-- Share Details -->
                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                        <FluentStack Orientation="Orientation.Horizontal" VerticalGap="4">
                                            <FluentLabel Style="font-size: 12px; color: var(--neutral-foreground-hint); width: 60px;">本地路径</FluentLabel>
                                            <FluentLabel Style="font-size: 12px; font-family: monospace; word-break: break-all;">
                                                @share.Path
                                            </FluentLabel>
                                        </FluentStack>

                                        <FluentStack Orientation="Orientation.Horizontal" VerticalGap="4">
                                            <FluentLabel Style="font-size: 12px; color: var(--neutral-foreground-hint); width: 60px;">权限</FluentLabel>
                                            <FluentLabel Style="font-size: 12px;">
                                                @GetSharePermissions(share)
                                            </FluentLabel>
                                        </FluentStack>

                                        @if (share.Type == ShareType.CIFS)
                                        {
                                            <FluentStack Orientation="Orientation.Horizontal" VerticalGap="4">
                                                <FluentLabel Style="font-size: 12px; color: var(--neutral-foreground-hint); width: 60px;">状态</FluentLabel>
                                                <FluentBadge Fill="success" BackgroundColor="#107c10" Color="white">
                                                    运行中
                                                </FluentBadge>
                                            </FluentStack>
                                        }
                                    </FluentStack>

                                    <!-- Share Actions -->
                                    <FluentDivider Style="margin: 0;" />
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                                        <FluentButton Appearance="Appearance.Lightweight" 
                                                    OnClick="@(() => EditShare(share))"
                                                    Style="flex: 1;">
                                            编辑配置
                                        </FluentButton>
                                        <FluentButton Appearance="Appearance.Lightweight" 
                                                    OnClick="@(() => OpenInFileManager(share))"
                                                    Style="flex: 1;">
                                            <FluentIcon Value="@(new Icons.Regular.Size16.FolderOpen())" />
                                            启用
                                        </FluentButton>
                                        <FluentButton Appearance="Appearance.Lightweight" 
                                                    OnClick="@(() => DeleteShare(share))"
                                                    Style="color: var(--error);">
                                            <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" Color="Color.Error" />
                                        </FluentButton>
                                    </FluentStack>
                                </FluentStack>
                            </FluentCard>
                        </FluentGridItem>
                    }
                </FluentGrid>
            }
        </FluentStack>
    }
</FluentStack>

<!-- Add Share Dialog (Placeholder) -->
<FluentDialog @bind-Hidden="@isAddShareDialogHidden" Modal="true">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.PaneHeader">添加共享</FluentLabel>
    </FluentDialogHeader>
    <FluentDialogBody>
        <p>添加共享对话框 (待实现)</p>
    </FluentDialogBody>
    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@(() => isAddShareDialogHidden = true)">取消</FluentButton>
        <FluentButton Appearance="Appearance.Accent">确定</FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private bool isAuthorized = false;
    private bool isLoading = true;
    private List<DiskInfo> allDisks = new();
    private List<ShareInfo> shares = new();
    private bool isAddShareDialogHidden = true;

    protected override async Task OnInitializedAsync()
    {
        isAuthorized = AuthStateService.IsAuthenticated && AuthStateService.IsAdmin;
        if (isAuthorized)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            allDisks = await DiskService.GetAllDisksAsync();
            shares = await ShareService.GetAllSharesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading disk and share data");
            ToastService.ShowError($"加载数据失败: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshAll()
    {
        await LoadData();
        ToastService.ShowSuccess("数据已刷新");
    }

    private string GetDiskDisplayName(DiskInfo disk)
    {
        if (!string.IsNullOrEmpty(disk.Label))
            return disk.Label;
        if (!string.IsNullOrEmpty(disk.Model))
            return disk.Model;
        return disk.Name;
    }

    private Icon GetShareIcon(ShareInfo share)
    {
        if (share.Type == ShareType.CIFS)
            return new Icons.Regular.Size24.Folder();
        return new Icons.Regular.Size24.FolderSync();
    }

    private string GetShareTypeDisplay(ShareInfo share)
    {
        if (share.Type == ShareType.CIFS)
            return "SMB";
        return "NFS";
    }

    private string GetSharePermissions(ShareInfo share)
    {
        if (share.Type == ShareType.CIFS)
        {
            var permissions = new List<string>();
            if (share.GuestOk) permissions.Add("公开 (只读)");
            if (!string.IsNullOrEmpty(share.ValidUsers)) permissions.Add($"特定 IP 段 ({share.ValidUsers})");
            return permissions.Any() ? string.Join(", ", permissions) : "私有 (admin only)";
        }
        return share.ReadOnly ? "只读" : "读写";
    }

    private List<MenuItemModel> GetShareMenuItems(ShareInfo share)
    {
        return new List<MenuItemModel>();
    }

    private void OpenShareMenu(ShareInfo share)
    {
        // Placeholder for menu functionality
    }

    private async Task MountDisk(DiskInfo disk)
    {
        try
        {
            await DiskService.MountDiskAsync(disk.DevicePath, "", "");
            await LoadData();
            ToastService.ShowSuccess($"磁盘 {disk.Name} 已挂载");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"挂载失败: {ex.Message}");
        }
    }

    private async Task UnmountDisk(DiskInfo disk)
    {
        try
        {
            await DiskService.UnmountDiskAsync(disk.MountPoint);
            await LoadData();
            ToastService.ShowSuccess($"磁盘 {disk.Name} 已卸载");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"卸载失败: {ex.Message}");
        }
    }

    private void OpenDiskSettings(DiskInfo disk)
    {
        ToastService.ShowInfo("磁盘设置功能待实现");
    }

    private void OpenScanDiskDialog()
    {
        ToastService.ShowInfo("扫描磁盘功能待实现");
    }

    private void OpenAddShareDialog()
    {
        isAddShareDialogHidden = false;
    }

    private void EditShare(ShareInfo share)
    {
        ToastService.ShowInfo("编辑共享功能待实现");
    }

    private void OpenInFileManager(ShareInfo share)
    {
        Navigation.NavigateTo($"/file-manager/{Uri.EscapeDataString(share.Path)}");
    }

    private async Task DeleteShare(ShareInfo share)
    {
        try
        {
            if (share.Type == ShareType.CIFS)
            {
                await ShareService.RemoveCifsShareAsync(share.Name);
            }
            else
            {
                await ShareService.RemoveNfsShareAsync(share.Path);
            }
            await LoadData();
            ToastService.ShowSuccess($"共享 {share.Name} 已删除");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"删除失败: {ex.Message}");
        }
    }

    private class MenuItemModel
    {
        public string Text { get; set; } = string.Empty;
        public Action? OnClick { get; set; }
    }
}
