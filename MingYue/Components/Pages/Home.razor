@page "/"
@using MingYue.Models
@using MingYue.Services
@inject ISystemMonitorService SystemMonitorService

<PageTitle>Home</PageTitle>

<div class="home-shell">
    <div class="home-bg">
        <div class="bg-layer gradient-one"></div>
        <div class="bg-layer gradient-two"></div>
        <div class="bg-layer grain"></div>
    </div>

    <div class="home-container">
        <header class="home-header">
            <div class="brand">
                <div class="brand-icon">
                    <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.Grid())" />
                </div>
                <div>
                    <div class="brand-title">My Portal</div>
                    <div class="brand-subtitle">Home Server</div>
                </div>
            </div>
            <div class="header-actions">
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" Title="搜索">
                    <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Search())" />
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" Title="设置">
                    <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Settings())" />
                </FluentButton>
                <div class="avatar">
                    <span>M</span>
                </div>
            </div>
        </header>

        <main class="home-main">
            <section class="hero">
                <div class="hero-time">@TimeNow</div>
                <div class="hero-date">@DateNow</div>
            </section>

            <section class="status-grid">
                <FluentCard class="glass-card accent-amber">
                    <div class="card-header">
                        <div>
                            <div class="card-label">天气</div>
                            <div class="card-title">@WeatherTemperature°</div>
                            <div class="card-sub">@WeatherSummary</div>
                            <div class="card-meta">最高 22° / 最低 14°</div>
                        </div>
                        <div class="pill">晴</div>
                    </div>
                    <div class="progress-bar">
                        <div style="width:60%"></div>
                    </div>
                </FluentCard>

                <FluentCard class="glass-card accent-blue">
                    <div class="card-header spaced">
                        <div class="card-label">系统监控</div>
                        <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.DeveloperBoard())" />
                    </div>
                    <div class="metric">
                        <div class="metric-row">
                            <span>CPU</span>
                            <span class="metric-value">@systemInfo.Cpu.UsagePercent.ToString("F1")%</span>
                        </div>
                        <div class="progress-bar small">
                            <div style="width:@Math.Clamp(systemInfo.Cpu.UsagePercent,0,100)%"></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-row">
                            <span>RAM</span>
                            <span class="metric-value purple">@systemInfo.Memory.UsedGB</span>
                        </div>
                        <div class="progress-bar small">
                            <div class="purple" style="width:@Math.Clamp(systemInfo.Memory.UsagePercent,0,100)%"></div>
                        </div>
                    </div>
                </FluentCard>

                <FluentCard class="glass-card accent-green">
                    <div class="card-header spaced">
                        <div class="card-label">网络状态</div>
                        <div class="status-dot"></div>
                    </div>
                    <div class="network-grid">
                        <div class="network-chip">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowDownload())" />
                            <div class="metric-number">24</div>
                            <div class="metric-unit">MB/s</div>
                        </div>
                        <div class="network-chip">
                            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowUpload())" />
                            <div class="metric-number">12</div>
                            <div class="metric-unit">MB/s</div>
                        </div>
                    </div>
                </FluentCard>
            </section>

            <section class="apps">
                <div class="section-head">
                    <h3>应用程序</h3>
                    <FluentButton Appearance="Appearance.Stealth">查看全部</FluentButton>
                </div>
                <div class="apps-grid">
                    @foreach (var app in AppShortcuts)
                    {
                        <a class="app-tile" href="@app.Link">
                            <div class="app-icon" style=@($"background: {app.Gradient}")>
                                <span>@app.Initials</span>
                            </div>
                            <div class="app-meta">
                                <div class="app-name">@app.Title</div>
                                <div class="app-tag">@app.Category</div>
                            </div>
                        </a>
                    }
                    <button class="app-tile add-tile" type="button">
                        <div class="app-icon add-icon">
                            <span>+</span>
                        </div>
                        <div class="app-meta">
                            <div class="app-name">添加</div>
                            <div class="app-tag">新应用</div>
                        </div>
                    </button>
                </div>
            </section>
        </main>

        <footer class="dock">
            <div class="dock-inner">
                @foreach (var item in DockItems)
                {
                    <a class="dock-btn" href="@item.Link" title="@item.Label">
                        <FluentIcon Value="@item.Icon" />
                        <span>@item.Label</span>
                    </a>
                }
            </div>
        </footer>
    </div>
</div>


@code {
    public string TimeNow => DateTime.Now.ToString("HH:mm");
    public string DateNow => $"{DateTime.Now:yyyy年MM月dd日}, {GetDayOfWeek()}";
    public string WeatherSummary => "晴朗";
    public int WeatherTemperature => 18;
    public SystemResourceInfo systemInfo = new();

    public List<AppShortcut> AppShortcuts { get; set; } = new()
    {
        new("Jellyfin", "Media", "JF", "linear-gradient(135deg, #7c3aed, #312e81)", "#"),
        new("Plex", "Media", "PL", "linear-gradient(135deg, #f59e0b, #b45309)", "#"),
        new("Home Asst", "Smart", "HA", "linear-gradient(135deg, #3b82f6, #06b6d4)", "#"),
        new("Pi-hole", "Security", "PH", "linear-gradient(135deg, #ef4444, #dc2626)", "#"),
        new("Nextcloud", "Storage", "NC", "linear-gradient(135deg, #2563eb, #1d4ed8)", "#"),
        new("TrueNAS", "NAS", "TN", "linear-gradient(135deg, #475569, #1f2937)", "#"),
        new("Grafana", "Stats", "GF", "linear-gradient(135deg, #f97316, #ea580c)", "#"),
        new("Portainer", "Docker", "PT", "linear-gradient(135deg, #22d3ee, #0ea5e9)", "#"),
    };

    public List<DockItem> DockItems { get; set; } = new()
    {
        new("概览", new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.LayoutDashboard(), "#"),
        new("终端", new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.CommandLine(), "#"),
        new("文件", new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.FolderOpen(), "#"),
        new("设置", new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.Settings(), "#")
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDataAsync();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    public string GetDayOfWeek()
    {
        return DateTime.Now.DayOfWeek switch
        {
            DayOfWeek.Monday => "星期一",
            DayOfWeek.Tuesday => "星期二",
            DayOfWeek.Wednesday => "星期三",
            DayOfWeek.Thursday => "星期四",
            DayOfWeek.Friday => "星期五",
            DayOfWeek.Saturday => "星期六",
            DayOfWeek.Sunday => "星期日",
            _ => ""
        };
    }

    public async Task LoadDataAsync()
    {
        try
        {
            systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception)
        {
        }
    }

    public record AppShortcut(string Title, string Category, string Initials, string Gradient, string Link);
    public record DockItem(string Label, Icon Icon, string Link);
}
