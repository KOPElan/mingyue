@page "/share-management"
@using MingYue.Models
@using MingYue.Services
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject IShareManagementService ShareService
@inject AuthenticationStateService AuthStateService
@inject NavigationManager Navigation
@inject ILogger<ShareManagement> Logger
@inject IToastService ToastService

<PageTitle>Share Management - MingYue</PageTitle>

@if (!isAuthorized)
{
    <FluentMessageBar Intent="MessageIntent.Error">
        <p>Access denied. You must be an administrator to access this page.</p>
    </FluentMessageBar>
    return;
}

<FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
    <h2 style="margin: 0;">Share Management</h2>

    @if (isLoading)
    {
        <FluentProgressRing />
    }
    else
    {
        <!-- SMB Users Section -->
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                <h3 style="margin: 0;">SMB Users</h3>
                <FluentSpacer />
                <FluentButton Appearance="Appearance.Accent" OnClick="@OpenAddUserDialog" IconStart="@(new Icons.Regular.Size16.Add())">
                    Add User
                </FluentButton>
            </FluentStack>

            @if (sambaUsers.Count == 0)
            {
                <FluentMessageBar Intent="MessageIntent.Info">
                    No SMB users configured. Click "Add User" to create one.
                </FluentMessageBar>
            }
            else
            {
                <FluentGrid Spacing="16">
                    @foreach (var user in sambaUsers)
                    {
                        <FluentGridItem xs="12" sm="6" md="3">
                            <FluentCard>
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" VerticalAlignment="VerticalAlignment.Center">
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" VerticalAlignment="VerticalAlignment.Center">
                                            <FluentIcon Value="@(new Icons.Regular.Size24.Person())" Color="Color.Accent" />
                                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@user.Username</FluentLabel>
                                        </FluentStack>
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4">
                                            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => OpenEditUserDialog(user))" title="Change Password">
                                                <FluentIcon Value="@(new Icons.Regular.Size16.Edit())" />
                                            </FluentButton>
                                            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => DeleteUser(user))" title="Delete">
                                                <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" Color="@Color.Error" />
                                            </FluentButton>
                                        </FluentStack>
                                    </FluentStack>
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Wrap="true">
                                        <FluentBadge Fill="info" BackgroundColor="blue" Color="white">UID: @user.Uid</FluentBadge>
                                        @if (user.HasSambaPassword)
                                        {
                                            <FluentBadge Fill="success" BackgroundColor="green" Color="white">Password Set</FluentBadge>
                                        }
                                        else
                                        {
                                            <FluentBadge Fill="neutral">No Password</FluentBadge>
                                        }
                                    </FluentStack>
                                </FluentStack>
                            </FluentCard>
                        </FluentGridItem>
                    }
                </FluentGrid>
            }
        </FluentStack>

        <!-- Samba Shares Section -->
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                <FluentLabel Typo="Typography.H3">Samba Shares</FluentLabel>
                <FluentSpacer />
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10">
                    <FluentButton Appearance="Appearance.Outline" OnClick="@RestartSambaService" IconStart="@(new Icons.Regular.Size16.ArrowSync())">
                        Restart Service
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Accent" OnClick="@(() => OpenAddDialog(ShareType.CIFS))" IconStart="@(new Icons.Regular.Size16.Add())">                        
                        Add
                    </FluentButton>
                </FluentStack>
            </FluentStack>

            @if (sambaShares.Count == 0)
            {
                <FluentMessageBar Intent="MessageIntent.Info">
                    No Samba shares configured. Click "Add" to create one.
                </FluentMessageBar>
            }
            else
            {
                <FluentGrid Spacing="16">
                    @foreach (var share in sambaShares)
                    {
                        <FluentGridItem xs="12" sm="6" md="4">
                            <FluentCard>
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                                    <!-- Header with Name and Actions -->
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" VerticalAlignment="VerticalAlignment.Center">
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" VerticalAlignment="VerticalAlignment.Center">
                                            <FluentIcon Value="@(new Icons.Regular.Size24.FolderOpen())" Color="Color.Accent" />
                                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@share.Name</FluentLabel>
                                        </FluentStack>
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4">
                                            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => OpenEditDialog(share))" title="Edit">
                                                <FluentIcon Value="@(new Icons.Regular.Size16.Edit())" />
                                            </FluentButton>
                                            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => DeleteShare(share))" title="Delete">
                                                <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" Color="@Color.Error" />
                                            </FluentButton>
                                        </FluentStack>
                                    </FluentStack>

                                    <!-- Path -->
                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Path</FluentLabel>
                                        <FluentLabel Typo="Typography.Body" Style="font-family: monospace; font-size: 13px;">@share.Path</FluentLabel>
                                    </FluentStack>

                                    <!-- Badges -->
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Wrap="true">
                                        @if (share.ReadOnly)
                                        {
                                            <FluentBadge Fill="neutral">Read-Only</FluentBadge>
                                        }
                                        else
                                        {
                                            <FluentBadge Fill="success" BackgroundColor="green" Color="white">Read-Write</FluentBadge>
                                        }
                                        
                                        @if (share.GuestOk)
                                        {
                                            <FluentBadge Fill="highlight" BackgroundColor="orange" Color="white">Guest Access</FluentBadge>
                                        }
                                        
                                        @if (share.Browseable)
                                        {
                                            <FluentBadge Fill="info" BackgroundColor="blue" Color="white">Browseable</FluentBadge>
                                        }
                                    </FluentStack>

                                    <!-- Description -->
                                    @if (!string.IsNullOrEmpty(share.Comment))
                                    {
                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                            <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Description</FluentLabel>
                                            <FluentLabel Typo="Typography.Body" Style="font-size: 13px;">@share.Comment</FluentLabel>
                                        </FluentStack>
                                    }
                                </FluentStack>
                            </FluentCard>
                        </FluentGridItem>
                    }
                </FluentGrid>
            }
        </FluentStack>

        <!-- NFS Shares Section -->
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                <FluentLabel Typo="Typography.H3">NFS Shares</FluentLabel>
                <FluentSpacer />
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10">
                    <FluentButton Appearance="Appearance.Outline" OnClick="@RestartNfsService" IconStart="@(new Icons.Regular.Size16.ArrowSync())">
                        Restart Service
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Accent" OnClick="@(() => OpenAddDialog(ShareType.NFS))" IconStart="@(new Icons.Regular.Size16.Add())">
                        Add
                    </FluentButton>
                </FluentStack>
            </FluentStack>

            @if (nfsShares.Count == 0)
            {
                <FluentMessageBar Intent="MessageIntent.Info">
                    No NFS shares configured. Click "Add" to create one.
                </FluentMessageBar>
            }
            else
            {
                <FluentGrid Spacing="16">
                    @foreach (var share in nfsShares)
                    {
                        <FluentGridItem xs="12" sm="6" md="4">
                            <FluentCard>
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                                    <!-- Header with Name and Actions -->
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" VerticalAlignment="VerticalAlignment.Center">
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" VerticalAlignment="VerticalAlignment.Center">
                                            <FluentIcon Value="@(new Icons.Regular.Size24.FolderOpen())" Color="Color.Accent" />
                                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@share.Name</FluentLabel>
                                        </FluentStack>
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="4">
                                            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => OpenEditDialog(share))" title="Edit">
                                                <FluentIcon Value="@(new Icons.Regular.Size16.Edit())" />
                                            </FluentButton>
                                            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => DeleteShare(share))" title="Delete">
                                                <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" Color="@Color.Error" />
                                            </FluentButton>
                                        </FluentStack>
                                    </FluentStack>

                                    <!-- Path -->
                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Path</FluentLabel>
                                        <FluentLabel Typo="Typography.Body" Style="font-family: monospace; font-size: 13px;">@share.Path</FluentLabel>
                                    </FluentStack>

                                    <!-- Allowed Hosts -->
                                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                        <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Allowed Hosts</FluentLabel>
                                        <FluentLabel Typo="Typography.Body" Style="font-family: monospace; font-size: 13px;">@share.AllowedHosts</FluentLabel>
                                    </FluentStack>

                                    <!-- Badges -->
                                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Wrap="true">
                                        @if (share.ReadOnly)
                                        {
                                            <FluentBadge Fill="neutral">Read-Only</FluentBadge>
                                        }
                                        else
                                        {
                                            <FluentBadge Fill="success" BackgroundColor="green" Color="white">Read-Write</FluentBadge>
                                        }
                                    </FluentStack>

                                    <!-- Description -->
                                    @if (!string.IsNullOrEmpty(share.Comment))
                                    {
                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                                            <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Description</FluentLabel>
                                            <FluentLabel Typo="Typography.Body" Style="font-size: 13px;">@share.Comment</FluentLabel>
                                        </FluentStack>
                                    }
                                </FluentStack>
                            </FluentCard>
                        </FluentGridItem>
                    }
                </FluentGrid>
            }
        </FluentStack>
    }
</FluentStack>

<!-- Add/Edit Share Dialog -->
<FluentDialog @ref="shareDialog" @bind-Hidden="@isShareDialogHidden" TrapFocus="true" Modal="true" Style="min-width: 600px;">
    <FluentDialogHeader ShowDismiss="true">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Icons.Regular.Size24.FolderOpen())" />
            <FluentLabel Typo="Typography.PaneHeader">
                @(editingShare == null ? "Add" : "Edit") @(currentShare.Type == ShareType.CIFS ? "Samba" : "NFS") Share
            </FluentLabel>
        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>
        <EditForm Model="@currentShare" OnValidSubmit="@SaveShare">
            <DataAnnotationsValidator />
            
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                <FluentTextField 
                    @bind-Value="currentShare.Name"
                    Label="@(currentShare.Type == ShareType.CIFS ? "Share Name" : "Export Name")"
                    Required="true"
                    Placeholder="@(currentShare.Type == ShareType.CIFS ? "MyShare" : "data")"
                    Style="width: 100%;" />
                
                <FluentTextField 
                    @bind-Value="currentShare.Path"
                    Label="Directory Path"
                    Required="true"
                    Placeholder="/path/to/directory"
                    Style="width: 100%;" />
                
                <FluentTextField 
                    @bind-Value="currentShare.Comment"
                    Label="Description"
                    Placeholder="Optional description"
                    Style="width: 100%;" />
                
                <FluentCheckbox 
                    @bind-Value="currentShare.ReadOnly"
                    Label="Read-only" />
                
                @if (currentShare.Type == ShareType.CIFS)
                {
                    <!-- Samba-specific options -->
                    <FluentCheckbox 
                        @bind-Value="currentShare.GuestOk"
                        Label="Allow guest access (no password required)" />
                    
                    <FluentCheckbox 
                        @bind-Value="currentShare.Browseable"
                        Label="Browseable" />
                    
                    <!-- User Selection -->
                    @if (!currentShare.GuestOk && sambaUsers.Count > 0)
                    {
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Weight="FontWeight.Bold">Valid Users</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Select users who can access this share</FluentLabel>
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="8" Style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid var(--neutral-stroke-rest); border-radius: 4px;">
                                @foreach (var user in sambaUsers)
                                {
                                    <FluentCheckbox 
                                        Value="@selectedValidUsers.Contains(user.Username)"
                                        ValueChanged="@((bool isChecked) => OnValidUserChanged(user.Username, isChecked))"
                                        Label="@user.Username" />
                                }
                            </FluentStack>
                        </FluentStack>

                        @if (!currentShare.ReadOnly)
                        {
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                                <FluentLabel Weight="FontWeight.Bold">Write Permissions</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-hint); font-size: 12px;">Select users who can write to this share</FluentLabel>
                                <FluentStack Orientation="Orientation.Vertical" VerticalGap="8" Style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid var(--neutral-stroke-rest); border-radius: 4px;">
                                    @foreach (var user in sambaUsers.Where(u => selectedValidUsers.Contains(u.Username)))
                                    {
                                        <FluentCheckbox 
                                            Value="@selectedWriteUsers.Contains(user.Username)"
                                            ValueChanged="@((bool isChecked) => OnWriteUserChanged(user.Username, isChecked))"
                                            Label="@user.Username" />
                                    }
                                </FluentStack>
                            </FluentStack>
                        }
                    }
                    else if (!currentShare.GuestOk && sambaUsers.Count == 0)
                    {
                        <FluentMessageBar Intent="MessageIntent.Warning">
                            No SMB users configured. Please add SMB users first or enable guest access.
                        </FluentMessageBar>
                    }
                    
                    <FluentStack Orientation="Orientation.Horizontal" VerticalGap="10">
                        <FluentTextField 
                            @bind-Value="currentShare.CreateMask"
                            Label="Create Mask"
                            Placeholder="0744"
                            Style="flex: 1;" />
                        
                        <FluentTextField 
                            @bind-Value="currentShare.DirectoryMask"
                            Label="Directory Mask"
                            Placeholder="0755"
                            Style="flex: 1;" />
                    </FluentStack>
                }
                else
                {
                    <!-- NFS-specific options -->
                    <FluentTextField 
                        @bind-Value="currentShare.AllowedHosts"
                        Label="Allowed Hosts"
                        Required="true"
                        Placeholder="* or 192.168.1.0/24"
                        Style="width: 100%;">
                        <FluentLabel Slot="help-text">IP addresses or networks allowed to access (use * for all)</FluentLabel>
                    </FluentTextField>
                    
                    <FluentTextField 
                        @bind-Value="currentShare.NfsOptions"
                        Label="NFS Options"
                        Placeholder="rw,sync,no_subtree_check"
                        Style="width: 100%;">
                        <FluentLabel Slot="help-text">Comma-separated NFS export options</FluentLabel>
                    </FluentTextField>
                }
            </FluentStack>
        </EditForm>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveShare">
            Save
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CloseShareDialog">
            Cancel
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Delete Confirmation Dialog -->
<FluentDialog @ref="deleteDialog" @bind-Hidden="@isDeleteDialogHidden" TrapFocus="true" Modal="true">
    <FluentDialogHeader ShowDismiss="true">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Icons.Regular.Size24.Warning())" Color="@Color.Error" />
            <FluentLabel Typo="Typography.PaneHeader">
                Confirm Delete
            </FluentLabel>
        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>
        <FluentLabel Typo="Typography.Body">
            Are you sure you want to delete the share "@shareToDelete?.Name"?
        </FluentLabel>
        <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-top: 15px;">
            This action cannot be undone. The directory will not be deleted, only the share configuration.
        </FluentMessageBar>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@ConfirmDeleteShare">
            Delete
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CloseDeleteDialog">
            Cancel
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Add/Edit User Dialog -->
<FluentDialog @ref="userDialog" @bind-Hidden="@isUserDialogHidden" TrapFocus="true" Modal="true" Style="min-width: 500px;">
    <FluentDialogHeader ShowDismiss="true">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Icons.Regular.Size24.Person())" />
            <FluentLabel Typo="Typography.PaneHeader">
                @(editingUser == null ? "Add" : "Edit") SMB User
            </FluentLabel>
        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
            <FluentTextField 
                @bind-Value="currentUser.Username"
                Label="Username"
                Required="true"
                Placeholder="Enter username"
                Disabled="@(editingUser != null)"
                Style="width: 100%;">
                <FluentLabel Slot="help-text">@(editingUser == null ? "Username must exist as a system user" : "Username cannot be changed")</FluentLabel>
            </FluentTextField>
            
            <FluentTextField 
                @bind-Value="currentUser.Password"
                Label="@(editingUser == null ? "Password" : "New Password")"
                TextFieldType="TextFieldType.Password"
                Required="true"
                Placeholder="Enter password"
                Style="width: 100%;">
                <FluentLabel Slot="help-text">Set the Samba password for this user</FluentLabel>
            </FluentTextField>

            <FluentTextField 
                @bind-Value="confirmPassword"
                Label="Confirm Password"
                TextFieldType="TextFieldType.Password"
                Required="true"
                Placeholder="Re-enter password"
                Style="width: 100%;" />
        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveUser">
            Save
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CloseUserDialog">
            Cancel
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- Delete User Confirmation Dialog -->
<FluentDialog @ref="deleteUserDialog" @bind-Hidden="@isDeleteUserDialogHidden" TrapFocus="true" Modal="true">
    <FluentDialogHeader ShowDismiss="true">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Icons.Regular.Size24.Warning())" Color="@Color.Error" />
            <FluentLabel Typo="Typography.PaneHeader">
                Confirm Delete User
            </FluentLabel>
        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>
        <FluentLabel Typo="Typography.Body">
            Are you sure you want to delete the SMB user "@userToDelete?.Username"?
        </FluentLabel>
        <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-top: 15px;">
            This will remove the user's Samba password. The system user account will not be deleted.
        </FluentMessageBar>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@ConfirmDeleteUser">
            Delete
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CloseDeleteUserDialog">
            Cancel
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<ShareInfo> sambaShares = new();
    private List<ShareInfo> nfsShares = new();
    private List<SambaUser> sambaUsers = new();
    
    private FluentDialog? shareDialog;
    private FluentDialog? deleteDialog;
    private FluentDialog? userDialog;
    private FluentDialog? deleteUserDialog;
    private bool isLoading = true;
    private bool isAuthorized = false;
    private bool isShareDialogHidden = true;
    private bool isDeleteDialogHidden = true;
    private bool isUserDialogHidden = true;
    private bool isDeleteUserDialogHidden = true;
    
    private ShareInfo? editingShare;
    private ShareRequest currentShare = new();
    private ShareInfo? shareToDelete;
    
    private SambaUser? editingUser;
    private SambaUserRequest currentUser = new();
    private SambaUser? userToDelete;
    private string confirmPassword = string.Empty;
    
    // User selection for shares
    private HashSet<string> selectedValidUsers = new();
    private HashSet<string> selectedWriteUsers = new();

    /// <summary>
    /// Initialize the page
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // Authentication is handled by AuthenticationGuard
        // Only check if user is admin
        if (!AuthStateService.IsAdmin)
        {
            isAuthorized = false;
            Logger.LogWarning("Non-admin user {Username} attempted to access share management", 
                AuthStateService.CurrentUser?.Username);
            return;
        }

        isAuthorized = true;
        await LoadData();
    }

    /// <summary>
    /// Load all data (shares and users)
    /// </summary>
    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var cifsTask = ShareService.GetCifsSharesAsync();
            var nfsTask = ShareService.GetNfsSharesAsync();
            var usersTask = ShareService.GetSambaUsersAsync();

            await Task.WhenAll(cifsTask, nfsTask, usersTask);

            sambaShares = cifsTask.Result;
            nfsShares = nfsTask.Result;
            sambaUsers = usersTask.Result;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading data");
            ToastService.ShowError("Failed to load data");
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Load all shares (CIFS and NFS)
    /// </summary>
    private async Task LoadShares()
    {
        try
        {
            var cifsTask = ShareService.GetCifsSharesAsync();
            var nfsTask = ShareService.GetNfsSharesAsync();

            await Task.WhenAll(cifsTask, nfsTask);

            sambaShares = cifsTask.Result;
            nfsShares = nfsTask.Result;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading shares");
            ToastService.ShowError("Failed to load shares");
        }
    }

    /// <summary>
    /// Load Samba users
    /// </summary>
    private async Task LoadUsers()
    {
        try
        {
            sambaUsers = await ShareService.GetSambaUsersAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading users");
            ToastService.ShowError("Failed to load users");
        }
    }

    #region Share Management

    /// <summary>
    /// Open add share dialog
    /// </summary>
    private void OpenAddDialog(ShareType type)
    {
        editingShare = null;
        currentShare = new ShareRequest
        {
            Type = type,
            Browseable = true,
            CreateMask = "0744",
            DirectoryMask = "0755",
            AllowedHosts = "*",
            NfsOptions = "rw,sync,no_subtree_check"
        };
        selectedValidUsers.Clear();
        selectedWriteUsers.Clear();
        isShareDialogHidden = false;
    }

    /// <summary>
    /// Open edit share dialog
    /// </summary>
    private void OpenEditDialog(ShareInfo share)
    {
        editingShare = share;
        currentShare = new ShareRequest
        {
            Name = share.Name,
            Path = share.Path,
            Type = share.Type,
            Comment = share.Comment,
            Browseable = share.Browseable,
            ReadOnly = share.ReadOnly,
            GuestOk = share.GuestOk,
            ValidUsers = share.ValidUsers,
            WriteList = share.WriteList,
            CreateMask = share.CreateMask,
            DirectoryMask = share.DirectoryMask,
            AllowedHosts = share.AllowedHosts,
            NfsOptions = share.NfsOptions
        };
        
        // Parse existing users into selection sets
        selectedValidUsers.Clear();
        selectedWriteUsers.Clear();
        if (!string.IsNullOrEmpty(share.ValidUsers))
        {
            foreach (var user in share.ValidUsers.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
            {
                selectedValidUsers.Add(user);
            }
        }
        if (!string.IsNullOrEmpty(share.WriteList))
        {
            foreach (var user in share.WriteList.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
            {
                selectedWriteUsers.Add(user);
            }
        }
        
        isShareDialogHidden = false;
    }
    
    /// <summary>
    /// Handle valid user checkbox change
    /// </summary>
    private void OnValidUserChanged(string username, bool isChecked)
    {
        if (isChecked)
        {
            selectedValidUsers.Add(username);
        }
        else
        {
            selectedValidUsers.Remove(username);
            // If user is removed from valid users, also remove from write users
            selectedWriteUsers.Remove(username);
        }
    }
    
    /// <summary>
    /// Handle write user checkbox change
    /// </summary>
    private void OnWriteUserChanged(string username, bool isChecked)
    {
        if (isChecked)
        {
            selectedWriteUsers.Add(username);
        }
        else
        {
            selectedWriteUsers.Remove(username);
        }
    }

    /// <summary>
    /// Save share (add or update)
    /// </summary>
    private async Task SaveShare()
    {
        try
        {
            // Validate required fields
            if (string.IsNullOrWhiteSpace(currentShare.Name))
            {
                ToastService.ShowError("Share name is required");
                return;
            }

            if (string.IsNullOrWhiteSpace(currentShare.Path))
            {
                ToastService.ShowError("Directory path is required");
                return;
            }

            if (currentShare.Type == ShareType.NFS && string.IsNullOrWhiteSpace(currentShare.AllowedHosts))
            {
                ToastService.ShowError("Allowed hosts is required for NFS shares");
                return;
            }
            
            // For CIFS shares, set user lists from selected users
            if (currentShare.Type == ShareType.CIFS && !currentShare.GuestOk)
            {
                currentShare.ValidUsers = string.Join(", ", selectedValidUsers);
                currentShare.WriteList = string.Join(", ", selectedWriteUsers);
            }

            OperationResult result;

            if (editingShare == null)
            {
                // Add new share
                result = currentShare.Type == ShareType.CIFS
                    ? await ShareService.AddCifsShareAsync(currentShare)
                    : await ShareService.AddNfsShareAsync(currentShare);

                if (result.Success)
                {
                    ToastService.ShowSuccess($"{currentShare.Type} share created successfully");
                }
            }
            else
            {
                // Update existing share
                result = currentShare.Type == ShareType.CIFS
                    ? await ShareService.UpdateCifsShareAsync(editingShare.Name, currentShare)
                    : await ShareService.UpdateNfsShareAsync(editingShare.Path, currentShare);

                if (result.Success)
                {
                    ToastService.ShowSuccess($"{currentShare.Type} share updated successfully");
                }
            }

            if (result.Success)
            {
                await LoadShares();
                CloseShareDialog();
            }
            else
            {
                ToastService.ShowError(result.Message);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving share");
            ToastService.ShowError("Failed to save share");
        }
    }

    /// <summary>
    /// Open delete confirmation dialog
    /// </summary>
    private void DeleteShare(ShareInfo share)
    {
        shareToDelete = share;
        isDeleteDialogHidden = false;
    }

    /// <summary>
    /// Confirm and delete share
    /// </summary>
    private async Task ConfirmDeleteShare()
    {
        if (shareToDelete == null) return;

        try
        {
            var result = shareToDelete.Type == ShareType.CIFS
                ? await ShareService.RemoveCifsShareAsync(shareToDelete.Name)
                : await ShareService.RemoveNfsShareAsync(shareToDelete.Path);

            if (result.Success)
            {
                ToastService.ShowSuccess($"{shareToDelete.Type} share deleted successfully");
                await LoadShares();
            }
            else
            {
                ToastService.ShowError(result.Message);
            }

            CloseDeleteDialog();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting share");
            ToastService.ShowError("Failed to delete share");
        }
    }

    /// <summary>
    /// Close share dialog
    /// </summary>
    private void CloseShareDialog()
    {
        isShareDialogHidden = true;
        editingShare = null;
    }

    /// <summary>
    /// Close delete confirmation dialog
    /// </summary>
    private void CloseDeleteDialog()
    {
        isDeleteDialogHidden = true;
        shareToDelete = null;
    }

    #endregion

    #region Service Management

    /// <summary>
    /// Restart Samba service
    /// </summary>
    private async Task RestartSambaService()
    {
        try
        {
            var result = await ShareService.RestartSambaServiceAsync();

            if (result.Success)
            {
                ToastService.ShowSuccess("Samba service restarted successfully");
            }
            else
            {
                ToastService.ShowError(result.Message);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error restarting Samba service");
            ToastService.ShowError("Failed to restart Samba service");
        }
    }

    /// <summary>
    /// Restart NFS service
    /// </summary>
    private async Task RestartNfsService()
    {
        try
        {
            var result = await ShareService.RestartNfsServiceAsync();

            if (result.Success)
            {
                ToastService.ShowSuccess("NFS service restarted successfully");
            }
            else
            {
                ToastService.ShowError(result.Message);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error restarting NFS service");
            ToastService.ShowError("Failed to restart NFS service");
        }
    }

    #endregion
    
    #region User Management
    
    /// <summary>
    /// Open add user dialog
    /// </summary>
    private void OpenAddUserDialog()
    {
        editingUser = null;
        currentUser = new SambaUserRequest();
        confirmPassword = string.Empty;
        isUserDialogHidden = false;
    }
    
    /// <summary>
    /// Open edit user dialog (change password)
    /// </summary>
    private void OpenEditUserDialog(SambaUser user)
    {
        editingUser = user;
        currentUser = new SambaUserRequest
        {
            Username = user.Username
        };
        confirmPassword = string.Empty;
        isUserDialogHidden = false;
    }
    
    /// <summary>
    /// Save user (add or update password)
    /// </summary>
    private async Task SaveUser()
    {
        try
        {
            // Validate required fields
            if (string.IsNullOrWhiteSpace(currentUser.Username))
            {
                ToastService.ShowError("Username is required");
                return;
            }
            
            if (string.IsNullOrWhiteSpace(currentUser.Password))
            {
                ToastService.ShowError("Password is required");
                return;
            }
            
            if (currentUser.Password != confirmPassword)
            {
                ToastService.ShowError("Passwords do not match");
                return;
            }
            
            OperationResult result;
            
            if (editingUser == null)
            {
                // Add new user
                result = await ShareService.AddSambaUserAsync(currentUser);
                
                if (result.Success)
                {
                    ToastService.ShowSuccess($"SMB user '{currentUser.Username}' added successfully");
                }
            }
            else
            {
                // Update user password
                result = await ShareService.UpdateSambaUserPasswordAsync(currentUser.Username, currentUser.Password);
                
                if (result.Success)
                {
                    ToastService.ShowSuccess($"Password updated for user '{currentUser.Username}'");
                }
            }
            
            if (result.Success)
            {
                await LoadUsers();
                CloseUserDialog();
            }
            else
            {
                ToastService.ShowError(result.Message);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving user");
            ToastService.ShowError("Failed to save user");
        }
    }
    
    /// <summary>
    /// Open delete user confirmation dialog
    /// </summary>
    private void DeleteUser(SambaUser user)
    {
        userToDelete = user;
        isDeleteUserDialogHidden = false;
    }
    
    /// <summary>
    /// Confirm and delete user
    /// </summary>
    private async Task ConfirmDeleteUser()
    {
        if (userToDelete == null) return;
        
        try
        {
            var result = await ShareService.RemoveSambaUserAsync(userToDelete.Username);
            
            if (result.Success)
            {
                ToastService.ShowSuccess($"SMB user '{userToDelete.Username}' deleted successfully");
                await LoadUsers();
            }
            else
            {
                ToastService.ShowError(result.Message);
            }
            
            CloseDeleteUserDialog();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting user");
            ToastService.ShowError("Failed to delete user");
        }
    }
    
    /// <summary>
    /// Close user dialog
    /// </summary>
    private void CloseUserDialog()
    {
        isUserDialogHidden = true;
        editingUser = null;
        confirmPassword = string.Empty;
    }
    
    /// <summary>
    /// Close delete user confirmation dialog
    /// </summary>
    private void CloseDeleteUserDialog()
    {
        isDeleteUserDialogHidden = true;
        userToDelete = null;
    }

    #endregion
}
