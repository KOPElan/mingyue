@page "/initial-setup"
@using MingYue.Models
@using MingYue.Services
@using MingYue.Resources
@using Microsoft.Extensions.Localization
@inject IAuthenticationService AuthService
@inject AuthenticationStateService AuthStateService
@inject NavigationManager Navigation
@inject ILogger<InitialSetup> Logger
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["InitialSetup"] - MingYue</PageTitle>

<div class="setup-container">
    <FluentCard class="setup-card">
        <div class="setup-header">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size48.Settings())" Color="@Color.Accent" />
            <h2>@Localizer["WelcomeToMingYue"]</h2>
            <p>@Localizer["LetsSetupAdmin"]</p>
        </div>

        @if (hasExistingUsers)
        {
            <FluentMessageBar Intent="MessageIntent.Warning">
                <p>@Localizer["UserExists"]</p>
            </FluentMessageBar>
            <FluentButton 
                Appearance="Appearance.Accent"
                OnClick="@(() => Navigation.NavigateTo("/login"))"
                Style="width: 100%; margin-top: 20px;">
                @Localizer["GoToLogin"]
            </FluentButton>
        }
        else
        {
            <EditForm Model="@registerRequest" OnValidSubmit="@HandleSetup">
                <DataAnnotationsValidator />
                
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
                    <FluentTextField 
                        @bind-Value="registerRequest.Username"
                        Label="@Localizer["Username"]"
                        Placeholder="@Localizer["ChooseUsername"]"
                        Required="true"
                        Style="width: 100%;" />
                    <ValidationMessage For="@(() => registerRequest.Username)" />

                    <FluentTextField 
                        @bind-Value="registerRequest.Password"
                        Label="@Localizer["Password"]"
                        Placeholder="@Localizer["ChoosePassword"]"
                        TextFieldType="TextFieldType.Password"
                        Required="true"
                        Style="width: 100%;" />
                    <ValidationMessage For="@(() => registerRequest.Password)" />

                    <FluentTextField 
                        @bind-Value="registerRequest.ConfirmPassword"
                        Label="@Localizer["ConfirmPassword"]"
                        Placeholder="@Localizer["ReenterPassword"]"
                        TextFieldType="TextFieldType.Password"
                        Required="true"
                        Style="width: 100%;" />
                    <ValidationMessage For="@(() => registerRequest.ConfirmPassword)" />

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <FluentMessageBar Intent="MessageIntent.Error">
                            @errorMessage
                        </FluentMessageBar>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <FluentMessageBar Intent="MessageIntent.Success">
                            @successMessage
                        </FluentMessageBar>
                    }

                    <FluentButton 
                        Type="ButtonType.Submit"
                        Appearance="Appearance.Accent"
                        Loading="@isLoading"
                        Style="width: 100%;">
                        @Localizer["CreateAdminAccount"]
                    </FluentButton>
                </FluentStack>
            </EditForm>

            <FluentDivider Style="margin: 20px 0;" />

            <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                <p style="text-align: center; color: var(--neutral-foreground-rest);">
                    @Localizer["AlreadyHaveAccount"]
                </p>
                <FluentButton 
                    Appearance="Appearance.Outline"
                    OnClick="@(() => Navigation.NavigateTo("/login"))"
                    Style="width: 100%;">
                    @Localizer["SignIn"]
                </FluentButton>
            </FluentStack>
        }
    </FluentCard>
</div>

<style>
    .setup-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .setup-card {
        width: 100%;
        max-width: 450px;
        padding: 40px;
    }

    .setup-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .setup-header h2 {
        margin: 16px 0 8px 0;
        color: var(--neutral-foreground-rest);
    }

    .setup-header p {
        margin: 0;
        color: var(--neutral-foreground-hint);
    }
</style>

@code {
    private readonly RegisterRequest registerRequest = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;
    private bool hasExistingUsers = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if users already exist
        hasExistingUsers = await AuthService.HasUsersAsync();

        if (hasExistingUsers)
        {
            Logger.LogInformation("Setup page accessed but users already exist");
        }
    }

    private async Task HandleSetup()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        isLoading = true;

        try
        {
            // Double check that no users exist
            if (await AuthService.HasUsersAsync())
            {
                errorMessage = Localizer["UserExists"];
                hasExistingUsers = true;
                return;
            }

            var response = await AuthService.RegisterAsync(registerRequest);

            if (response.Success && response.User != null)
            {
                successMessage = Localizer["AdminCreatedSuccess"];
                Logger.LogInformation("Administrator account created: {Username}", response.User.Username);
                
                // Auto-login after successful registration
                await AuthStateService.SetCurrentUserAsync(response.User);
                
                // Redirect to home page after a brief delay
                await Task.Delay(1500);
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = response.Message;
                Logger.LogWarning("Setup failed: {Message}", response.Message);
            }
        }
        catch (Exception ex)
        {
            errorMessage = Localizer["SetupError"];
            Logger.LogError(ex, "Setup error");
        }
        finally
        {
            isLoading = false;
        }
    }
}
