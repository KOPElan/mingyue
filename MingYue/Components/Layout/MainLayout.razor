@inherits LayoutComponentBase
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@using MingYue.Components.Dialog
@using MingYue.Models
@using MingYue.Services
@inject IDialogService DialogService
@inject AuthenticationStateService AuthStateService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@implements IDisposable

<FluentDesignTheme @bind-Mode="@Settings.Mode" @bind-OfficeColor="@Settings.OfficeColor" StorageName="theme" />
<!-- Background Effects -->
<div class="home-bg-effects">
    <div class="bg-gradient-blob bg-gradient-blob-1"></div>
    <div class="bg-gradient-blob bg-gradient-blob-2"></div>
    <div class="bg-gradient-blob bg-gradient-blob-3"></div>
    <div class="bg-grid-pattern"></div>
</div>
    <!-- Standard layout for other pages -->
    <FluentLayout>    
        <!-- Header -->
        <div class="home-header">
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
            <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center" HorizontalGap="16">
                <div class="home-logo">
                    <FluentIcon Value="@(new Icons.Regular.Size24.GridDots())" Color="Color.Accent" />
                </div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="0">
                    <FluentLabel Typo="Typography.Body" Class="home-title-main">MingYue</FluentLabel>
                    <FluentLabel Typo="Typography.Body" Class="home-title-sub">Home Server</FluentLabel>
                </FluentStack>
            
            <FluentSpacer></FluentSpacer>
            
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/scheduled-tasks"))" Title="è®¡åˆ’ä»»åŠ¡">
                    <FluentIcon Value="@(new Icons.Regular.Size20.CalendarClock())"></FluentIcon>
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/anydrop"))" Title="Anydrop">
                    <FluentIcon Value="@(new Icons.Regular.Size20.ShareAndroid())"></FluentIcon>
                </FluentButton>
                <!-- Notification Button with Badge -->
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="OpenNotificationPanel" Title="é€šçŸ¥" Style="position: relative;">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Alert())" />
                    @if (unreadCount > 0)
                    {
                        <FluentBadge Appearance="Appearance.Accent" Style="position: absolute; top: 0; right: 0; min-width: 18px; height: 18px; padding: 0 4px; font-size: 10px;">
                            @(unreadCount > 99 ? "99+" : unreadCount.ToString())
                        </FluentBadge>
                    }
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/settings"))" Title="ç³»ç»Ÿè®¾ç½®">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Settings())" />
                </FluentButton>                                
                @if (AuthStateService.IsAuthenticated && AuthStateService.CurrentUser != null)
                {
                    <FluentLabel>@AuthStateService.CurrentUser.Username</FluentLabel>
                    @if (AuthStateService.IsAdmin)
                    {
                        <FluentBadge Fill="success" BackgroundColor="green" Color="white">Admin</FluentBadge>
                    }
                    <FluentButton Appearance="Appearance.Lightweight" OnClick="Logout" Title="Logout">
                        <FluentIcon Value="@(new Icons.Regular.Size20.SignOut())" />
                    </FluentButton>
                }
            </FluentStack>            
        </FluentStack>     
    </div>
        <div class="home-content">
            @Body
        </div>        
    </FluentLayout>


<FluentToastProvider />
<FluentDialogProvider />
<FluentTooltipProvider />
<FluentMessageBarProvider />
<FluentMenuProvider />
<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    public SettingModel Settings { get; set; } = new();
    private string _currentPath = "";
    private int unreadCount = 0;

    protected override async Task OnInitializedAsync()
    {
        AuthStateService.OnAuthenticationStateChanged += StateHasChanged;
        Navigation.LocationChanged += OnLocationChanged;
        NotificationService.NotificationsChanged += OnNotificationsChanged;
        UpdateCurrentPath();
        await UpdateUnreadCountAsync();
    }

    private async void OnNotificationsChanged(object? sender, EventArgs e)
    {
        await UpdateUnreadCountAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateUnreadCountAsync()
    {
        unreadCount = await NotificationService.GetUnreadCountAsync();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateCurrentPath();
        StateHasChanged();
    }

    private void UpdateCurrentPath()
    {
        _currentPath = Navigation.ToBaseRelativePath(Navigation.Uri);
    }

    public async Task OpenNotificationPanel()
    {
        var dialog = await DialogService.ShowPanelAsync<NotificationPanel>(new DialogParameters()
        {
            Alignment = HorizontalAlignment.Right,
            Title = "é€šçŸ¥ä¸­å¿ƒ",
            PrimaryAction = null,
            SecondaryAction = null,
        });
        await dialog.Result;
    }

    public async Task OpenSetting()
    {
        IDialogReference? _dialog;
        _dialog = await DialogService.ShowPanelAsync<SettingDialog>(Settings, new DialogParameters<SettingModel>()
        {
            Content = Settings,
            Alignment = HorizontalAlignment.Right,
            Title = $"Hello",
        });
        _ = await _dialog.Result;
        // HandlePanel(result);
    }

    private async Task Logout()
    {
        await AuthStateService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    public void Dispose()
    {
        AuthStateService.OnAuthenticationStateChanged -= StateHasChanged;
        Navigation.LocationChanged -= OnLocationChanged;
        NotificationService.NotificationsChanged -= OnNotificationsChanged;
    }
}
