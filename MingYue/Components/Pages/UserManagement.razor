@page "/user-management"
@using MingYue.Models
@using MingYue.Services
@using MingYue.Resources
@using Microsoft.Extensions.Localization
@inject IAuthenticationService AuthService
@inject AuthenticationStateService AuthStateService
@inject NavigationManager Navigation
@inject ILogger<UserManagement> Logger
@inject IToastService ToastService
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["UserManagement"] - MingYue</PageTitle>

@if (!isAuthorized)
{
    <FluentMessageBar Intent="MessageIntent.Error">
        <p>@Localizer["AccessDenied"]</p>
    </FluentMessageBar>
    return;
}

<FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
        <h2 style="margin: 0;">@Localizer["UserManagement"]</h2>
        <FluentSpacer />
    </FluentStack>

    @if (isLoading)
    {
        <FluentProgressRing />
    }
    else if (users.Count == 0)
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            @Localizer["NoUsers"]
        </FluentMessageBar>
    }
    else
    {
        <FluentDataGrid Items="@users.AsQueryable()" GridTemplateColumns="1fr 1fr 1.5fr 1.5fr 1fr">
            <PropertyColumn Property="@(u => u.Username)" Title="@Localizer["Username"]" Sortable="true" />
            <TemplateColumn Title="@Localizer["Role"]" Sortable="true">
                <FluentBadge Fill="User" BackgroundColor="@(context.Role == "Admin" ? "green" : "blue")" Color="white">
                    @context.Role
                </FluentBadge>
            </TemplateColumn>
            <PropertyColumn Property="@(u => u.CreatedAt)" Title="@Localizer["CreatedAt"]" Sortable="true" Format="yyyy-MM-dd HH:mm" />
            <PropertyColumn Property="@(u => u.LastLoginAt)" Title="@Localizer["LastLogin"]" Sortable="true" Format="yyyy-MM-dd HH:mm" />
            <TemplateColumn Title="@Localizer["Actions"]">
                <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => OpenEditDialog(context))" Title="@Localizer["EditRole"]">
                    <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.PersonEdit())" />
                </FluentButton>
                @if (AuthStateService.CurrentUser?.Id != context.Id)
                {
                    <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => DeleteUser(context))" Title="@Localizer["DeleteUser"]">
                        <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size16.Delete())" Color="@Color.Error" />
                    </FluentButton>
                }
            </TemplateColumn>
        </FluentDataGrid>
    }
</FluentStack>

<FluentDialog @ref="dialog" @bind-Hidden="@isDialogHidden" TrapFocus="true" Modal="true">
    <FluentDialogHeader ShowDismiss="true">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.Person())" />
            <FluentLabel Typo="Typography.PaneHeader">@Localizer["EditRole"]</FluentLabel>
        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
            <FluentLabel>@Localizer["User"]: <b>@selectedUser?.Username</b></FluentLabel>

            <FluentSelect TOption="string"
                          Label="@Localizer["Role"]"
                          @bind-Value="@newRole"
                          Items="@roles" />
        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@SaveUserRole">
            @Localizer["Save"]
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CloseDialog">
            @Localizer["Cancel"]
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private List<UserDto> users = new();
    private UserDto? selectedUser;
    private string newRole = "User";
    private readonly List<string> roles = new() { "Admin", "User" };
    private FluentDialog? dialog;
    private bool isLoading = true;
    private bool isAuthorized = false;
    private bool isDialogHidden = true;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthStateService.IsAdmin)
        {
            isAuthorized = false;
            Logger.LogWarning("Non-admin user {Username} attempted to access user management",
                AuthStateService.CurrentUser?.Username);
            return;
        }

        isAuthorized = true;
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            users = await AuthService.GetAllUsersAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading users");
            ToastService.ShowError(Localizer["FailedToLoadUsers"]);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenEditDialog(UserDto user)
    {
        selectedUser = user;
        newRole = user.Role;
        isDialogHidden = false;
    }

    private async Task SaveUserRole()
    {
        if (selectedUser == null) return;

        try
        {
            var success = await AuthService.UpdateUserRoleAsync(selectedUser.Id, newRole);
            if (success)
            {
                ToastService.ShowSuccess(Localizer["UserRoleUpdated"]);
                await LoadUsers();
                CloseDialog();
            }
            else
            {
                ToastService.ShowError(Localizer["UpdateUserRoleFailed"]);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving user role");
            ToastService.ShowError(Localizer["UpdateUserRoleFailed"]);
        }
    }

    private async Task DeleteUser(UserDto user)
    {
        if (AuthStateService.CurrentUser?.Id == user.Id)
        {
            ToastService.ShowWarning(Localizer["CannotDeleteSelf"]);
            return;
        }

        try
        {
            var success = await AuthService.DeleteUserAsync(user.Id);
            if (success)
            {
                ToastService.ShowSuccess(Localizer["UserDeleted"]);
                await LoadUsers();
            }
            else
            {
                ToastService.ShowError(Localizer["DeleteUserFailed"]);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting user");
            ToastService.ShowError(Localizer["DeleteUserFailed"]);
        }
    }

    private void CloseDialog()
    {
        isDialogHidden = true;
    }
}
