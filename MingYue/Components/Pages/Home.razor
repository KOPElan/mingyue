@page "/"
@using MingYue.Models
@using MingYue.Services
@using MingYue.Resources
@using Microsoft.Extensions.Localization
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject ISystemMonitorService SystemMonitorService
@inject IApplicationService ApplicationService
@inject IDockItemService DockItemService
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResources> Localizer
@implements IDisposable

<PageTitle>MingYue - Home Server Portal</PageTitle>

<!-- Main Content Container -->
<FluentStack Orientation="Orientation.Vertical" Class="home-content">
    <!-- Clock Section -->
    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" Class="home-clock-section">
        <div class="home-clock">@TimeNow</div>        
        <FluentLabel Typo="Typography.Body" Class="home-date">@DateNow</FluentLabel>
    </FluentStack>
    <!-- Info Cards -->
    <FluentGrid Justify="JustifyContent.Center" Class="home-info-cards" Style="width:100%">
        <FluentGridItem sm="4" xs="12">
            <!-- Weather Card -->
            <FluentCard Class="info-card info-card-weather">
                <div class="info-card-glow weather-glow"></div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                        <FluentLabel Typo="Typography.Body" Class="info-card-label">@Localizer["Weather"]</FluentLabel>
                        <div class="info-card-icon weather-icon">
                            <FluentIcon Value="@(new Icons.Regular.Size24.WeatherSunny())" Color="Color.Custom" CustomColor="#facc15" />
                        </div>
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="4">
                        <div class="weather-temp">18°</div>
                        <FluentLabel Typo="Typography.Body" Class="weather-condition">Clear</FluentLabel>
                        <FluentLabel Typo="Typography.Body" Class="weather-range">H: 22° / L: 14°</FluentLabel>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
        <FluentGridItem sm="4" xs="12">
            <!-- System Monitor Card -->
            <FluentCard Class="info-card info-card-system">
                <div class="info-card-glow system-glow"></div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                        <FluentLabel Typo="Typography.Body" Class="info-card-label">@Localizer["SystemMonitor"]</FluentLabel>
                        <FluentIcon Value="@(new Icons.Regular.Size20.Server())" />
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="6">
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                                <FluentLabel Typo="Typography.Body" Class="stat-label">@Localizer["CPU"]</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Class="stat-value-cyan">@systemInfo.Cpu.UsagePercent.ToString("F0")%</FluentLabel>
                            </FluentStack>
                            <FluentProgress Min="0" Max="100" Value="@((int)systemInfo.Cpu.UsagePercent)" Class="progress-bar-cyan" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="6">
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                                <FluentLabel Typo="Typography.Body" Class="stat-label">@Localizer["Memory"]</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Class="stat-value-purple">@systemInfo.Memory.UsedGB</FluentLabel>
                            </FluentStack>
                            <FluentProgress Min="0" Max="100" Value="@((int)systemInfo.Memory.UsagePercent)" Class="progress-bar-purple" />
                        </FluentStack>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
        <FluentGridItem sm="4" xs="12">
            <!-- Network Status Card -->
            <FluentCard Class="info-card info-card-network">
                <div class="info-card-glow network-glow"></div>
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                        <FluentLabel Typo="Typography.Body" Class="info-card-label">@Localizer["NetworkStatus"]</FluentLabel>
                        <div class="network-indicator"></div>
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="16">
                        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="4" Class="network-stat-item">
                            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowDownload())" Color="Color.Custom" CustomColor="#22c55e" />
                            <FluentLabel Typo="Typography.Body">@downloadSpeedDisplay</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Class="network-stat-unit">@downloadUnit</FluentLabel>
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="4" Class="network-stat-item">
                            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowUpload())" Color="Color.Custom" CustomColor="#60a5fa" />
                            <FluentLabel Typo="Typography.Body">@uploadSpeedDisplay</FluentLabel>
                            <FluentLabel Typo="Typography.Body" Class="network-stat-unit">@uploadUnit</FluentLabel>
                        </FluentStack>
                    </FluentStack>
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
    </FluentGrid>

    <FluentStack Orientation="Orientation.Vertical" VerticalGap="24" Class="home-applications">
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Class="home-section-header">
            <FluentLabel Typo="Typography.Header" Class="home-section-title">@Localizer["Applications"]</FluentLabel>
            <FluentAnchor Href="/app-management" Appearance="Appearance.Lightweight" Class="view-all-link">@Localizer["ViewAll"]</FluentAnchor>
        </FluentStack>
        <FluentGrid Spacing="10" class="app-grid" Style="width:100%;">
            @foreach (var app in visibleApplications)
            {
                <FluentGridItem xs="6" sm="4" md="2">
                    <FluentCard Class="app-card" @onclick="@(() => Navigation.NavigateTo(app.Url, true))">
                        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="12">
                            <div class="app-icon" style="background: @GetAppGradient(app.IconColor)">
                                @if (!string.IsNullOrEmpty(app.Icon))
                                {
                                    <FluentIcon Value="@GetIcon(app.Icon)" />
                                }
                                else
                                {
                                    <FluentIcon Value="@(new Icons.Regular.Size24.Apps())" />
                                }
                            </div>
                            <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="2" Class="app-info">
                                <FluentLabel Typo="Typography.Body" Class="app-title">@app.Title</FluentLabel>
                                <FluentLabel Typo="Typography.Body" Class="app-category">@app.Category</FluentLabel>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
            }
            <FluentGridItem xs="6" sm="4" md="2">
                <FluentCard Class="app-card app-card-add" @onclick="@(() => Navigation.NavigateTo("/app-management"))">
                    <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="12">
                        <div class="app-icon app-icon-add">
                            <FluentIcon Value="@(new Icons.Regular.Size24.Add())" />
                        </div>
                        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" Class="app-info">
                            <FluentLabel Typo="Typography.Body" Class="app-title">@Localizer["Add"]</FluentLabel>
                        </FluentStack>
                    </FluentStack>
                </FluentCard>
            </FluentGridItem>
        </FluentGrid>
    </FluentStack>
</FluentStack>

<!-- Bottom Dock -->
<FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center" HorizontalGap="8" Class="home-dock">
    @foreach (var item in dockItems.Take(4))
    {
        <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" Class="dock-item"
                      @onclick="@(() => Navigation.NavigateTo(item.Url))"
                      title="@item.Title">
            @if (!string.IsNullOrEmpty(item.Icon))
            {
                <FluentIcon Value="@GetIcon(item.Icon)" />
            }
            else
            {
                <FluentIcon Value="@(new Icons.Regular.Size24.Apps())" />
            }
            <FluentTooltip Anchor="@item.ItemId" Position="TooltipPosition.Top">@item.Title</FluentTooltip>
        </FluentButton>
    }
</FluentStack>


@code {
    private string TimeNow => DateTime.Now.ToString("HH:mm");
    private string DateNow => DateTime.Now.ToString(System.Globalization.CultureInfo.CurrentCulture.Name.StartsWith("zh") ? "yyyy年MM月dd日, 星期" : "MMMM dd, yyyy, ") + GetDayOfWeek();
    private SystemResourceInfo systemInfo = new();
    private List<Application> visibleApplications = new();
    private List<DockItem> dockItems = new();
    private System.Threading.Timer? updateTimer;

    private long lastBytesReceived = 0;
    private long lastBytesSent = 0;
    private DateTime lastUpdateTime = DateTime.MinValue;
    private string downloadSpeedDisplay = "0";
    private string uploadSpeedDisplay = "0";
    private string downloadUnit = "KB/S";
    private string uploadUnit = "KB/S";

    private static readonly Random _random = new Random();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();

        // Update time and system info every 3 seconds
        updateTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadSystemInfoAsync();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private async Task LoadDataAsync()
    {
        await Task.WhenAll(
            LoadSystemInfoAsync(),
            LoadApplicationsAsync(),
            LoadDockItemsAsync()
        );
    }

    private async Task LoadSystemInfoAsync()
    {
        try
        {
            systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();

            if (systemInfo.Networks.Any())
            {
                var mainNetwork = systemInfo.Networks.First();
                var now = DateTime.Now;

                if (lastUpdateTime != DateTime.MinValue)
                {
                    var elapsedSeconds = (now - lastUpdateTime).TotalSeconds;
                    if (elapsedSeconds > 0)
                    {
                        var diffReceived = mainNetwork.BytesReceived - lastBytesReceived;
                        var diffSent = mainNetwork.BytesSent - lastBytesSent;

                        // Handle counter reset
                        if (diffReceived < 0) diffReceived = 0;
                        if (diffSent < 0) diffSent = 0;

                        var downBps = diffReceived / elapsedSeconds;
                        var upBps = diffSent / elapsedSeconds;

                        (downloadSpeedDisplay, downloadUnit) = FormatSpeed(downBps);
                        (uploadSpeedDisplay, uploadUnit) = FormatSpeed(upBps);
                    }
                }

                lastBytesReceived = mainNetwork.BytesReceived;
                lastBytesSent = mainNetwork.BytesSent;
                lastUpdateTime = now;
            }
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private async Task LoadApplicationsAsync()
    {
        try
        {
            var allApps = await ApplicationService.GetAllApplicationsAsync();
            visibleApplications = allApps.Where(a => a.IsVisible).Take(8).ToList();
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private async Task LoadDockItemsAsync()
    {
        try
        {
            dockItems = await DockItemService.GetAllDockItemsAsync();
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private string GetDayOfWeek()
    {
        return DateTime.Now.DayOfWeek switch
        {
            DayOfWeek.Monday => "一",
            DayOfWeek.Tuesday => "二",
            DayOfWeek.Wednesday => "三",
            DayOfWeek.Thursday => "四",
            DayOfWeek.Friday => "五",
            DayOfWeek.Saturday => "六",
            DayOfWeek.Sunday => "日",
            _ => ""
        };
    }

    private string GetAppGradient(string? iconColor)
    {
        if (string.IsNullOrEmpty(iconColor))
        {
            // Default gradients for variety
            var gradients = new[]
            {
                "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
                "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",
                "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
                "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)"
            };
            return gradients[_random.Next(gradients.Length)];
        }
        return $"linear-gradient(135deg, {iconColor} 0%, {iconColor}dd 100%)";
    }

    private (string Speed, string Unit) FormatSpeed(double bytesPerSecond)
    {
        if (bytesPerSecond < 1024)
            return (bytesPerSecond.ToString("F0"), "B/S");
        if (bytesPerSecond < 1024 * 1024)
            return ((bytesPerSecond / 1024.0).ToString("F1"), "KB/S");
        if (bytesPerSecond < 1024 * 1024 * 1024)
            return ((bytesPerSecond / 1024.0 / 1024.0).ToString("F1"), "MB/S");

        return ((bytesPerSecond / 1024.0 / 1024.0 / 1024.0).ToString("F1"), "GB/S");
    }

    private Icon GetIcon(string iconName)
    {
        if (string.IsNullOrEmpty(iconName)) return new Icons.Regular.Size24.Apps();

        return iconName.ToLowerInvariant() switch
        {
            "apps" => new Icons.Regular.Size24.Apps(),
            "settings" => new Icons.Regular.Size24.Settings(),
            "folder" => new Icons.Regular.Size24.Folder(),
            "docker" or "box" => new Icons.Regular.Size24.Box(),
            "server" => new Icons.Regular.Size24.Server(),
            "harddrive" => new Icons.Regular.Size24.HardDrive(),
            "network" or "wifi" => new Icons.Regular.Size24.Wifi1(),
            "calendar" => new Icons.Regular.Size24.CalendarClock(),
            "share" => new Icons.Regular.Size24.ShareAndroid(),
            "people" or "users" => new Icons.Regular.Size24.People(),
            "home" => new Icons.Regular.Size24.Home(),
            "image" => new Icons.Regular.Size24.Image(),
            "video" => new Icons.Regular.Size24.Video(),
            "music" => new Icons.Regular.Size24.MusicNote2(),
            "document" => new Icons.Regular.Size24.Document(),
            _ => new Icons.Regular.Size24.Apps()
        };
    }

    public void Dispose()
    {
        updateTimer?.Dispose();
    }
}