@page "/network"
@using MingYue.Services
@using ApexCharts
@using FluentOrientation = Microsoft.FluentUI.AspNetCore.Components.Orientation
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject INetworkManagementService NetworkService
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject AuthenticationStateService AuthStateService
@implements IDisposable

<PageTitle>网络管理 - MingYue</PageTitle>

@if (!AuthStateService.IsAuthenticated)
{
    <FluentCard>
        <h3>未授权</h3>
        <p>您需要登录才能访问此页面。</p>
        <FluentButton Appearance="Appearance.Accent" OnClick="@(() => Navigation.NavigateTo("/login"))">
            前往登录
        </FluentButton>
    </FluentCard>
}
else
{
    <div style="padding: 24px;">
        <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="24">
            <!-- Header -->
            <FluentStack Orientation="FluentOrientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                <FluentLabel Typo="Typography.H3">网络管理</FluentLabel>
                <FluentButton Appearance="Appearance.Accent" OnClick="RefreshData">
                    <FluentIcon Value="@(new Icons.Regular.Size20.ArrowClockwise())" Slot="start" />
                    刷新
                </FluentButton>
            </FluentStack>

            <!-- Network Statistics Card -->
            @if (statistics != null)
            {
                <FluentCard>
                    <FluentLabel Typo="Typography.H5">网络统计</FluentLabel>
                    <FluentDivider />
                    
                    <!-- Real-time Traffic Chart -->
                    <div style="margin: 16px 0;">
                        <FluentLabel Typo="Typography.Body" Style="margin-bottom: 8px; display: block;">实时流量趋势 (每5秒更新)</FluentLabel>
                        <ApexChart TItem="ChartDataPoint"
                                   Title="网络流量监控"
                                   @ref="chart"
                                   Height="300"
                                   Options="chartOptions">
                            <ApexPointSeries TItem="ChartDataPoint"
                                           Items="receivedDataPoints"
                                           Name="接收速率"
                                           SeriesType="SeriesType.Line"
                                           XValue="@(e => e.X)"
                                           YValue="@(e => e.Y)"
                                           OrderByDescending="e => e.X"
                                           Color="#0078d4" />
                            <ApexPointSeries TItem="ChartDataPoint"
                                           Items="sentDataPoints"
                                           Name="发送速率"
                                           SeriesType="SeriesType.Line"
                                           XValue="@(e => e.X)"
                                           YValue="@(e => e.Y)"
                                           OrderByDescending="e => e.X"
                                           Color="#00cc6a" />
                        </ApexChart>
                    </div>
                    
                    <FluentDivider Style="margin: 16px 0;" />
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                        <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body">总接收流量</FluentLabel>
                            <FluentLabel Typo="Typography.H6" Style="color: var(--accent-fill-rest);">
                                @FormatBytes(statistics.TotalBytesReceived)
                            </FluentLabel>
                        </FluentStack>
                        <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body">总发送流量</FluentLabel>
                            <FluentLabel Typo="Typography.H6" Style="color: var(--accent-fill-rest);">
                                @FormatBytes(statistics.TotalBytesSent)
                            </FluentLabel>
                        </FluentStack>
                        <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body">总接收包数</FluentLabel>
                            <FluentLabel Typo="Typography.H6" Style="color: var(--accent-fill-rest);">
                                @statistics.TotalPacketsReceived.ToString("N0")
                            </FluentLabel>
                        </FluentStack>
                        <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="4">
                            <FluentLabel Typo="Typography.Body">总发送包数</FluentLabel>
                            <FluentLabel Typo="Typography.H6" Style="color: var(--accent-fill-rest);">
                                @statistics.TotalPacketsSent.ToString("N0")
                            </FluentLabel>
                        </FluentStack>
                    </div>
                    <FluentLabel Typo="Typography.Body" Style="margin-top: 12px; color: var(--neutral-foreground-hint); font-size: 12px;">
                        统计时间: @statistics.CollectedAt.ToString("yyyy-MM-dd HH:mm:ss")
                    </FluentLabel>
                </FluentCard>
            }

            <!-- Network Interfaces Table -->
            <FluentCard>
                <FluentLabel Typo="Typography.H5">网络接口</FluentLabel>
                <FluentDivider />
                
                @if (isLoading)
                {
                    <div style="text-align: center; padding: 40px;">
                        <FluentProgressRing />
                        <FluentLabel>加载中...</FluentLabel>
                    </div>
                }
                else if (interfaces.Count == 0)
                {
                    <div style="text-align: center; padding: 40px;">
                        <FluentLabel>未找到网络接口</FluentLabel>
                    </div>
                }
                else
                {
                    <FluentDataGrid Items="@interfaces.AsQueryable()" GridTemplateColumns="2fr 1fr 2fr 1fr 1fr 1fr 1fr" Style="margin-top: 16px;">
                        <PropertyColumn Property="@(i => i.Name)" Title="名称" Sortable="true" />
                        <PropertyColumn Property="@(i => i.Type)" Title="类型" Sortable="true" />
                        <TemplateColumn Title="IP地址">
                            <div>
                                @foreach (var ip in context.IpAddresses)
                                {
                                    <div>@ip</div>
                                }
                            </div>
                        </TemplateColumn>
                        <PropertyColumn Property="@(i => i.MacAddress)" Title="MAC地址" />
                        <TemplateColumn Title="速度">
                            @if (context.Speed > 0)
                            {
                                <span>@FormatSpeed(context.Speed)</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </TemplateColumn>
                        <TemplateColumn Title="状态" Sortable="true">
                            <FluentBadge Appearance="@(context.IsUp ? Appearance.Accent : Appearance.Neutral)">
                                @context.Status
                            </FluentBadge>
                        </TemplateColumn>
                        <TemplateColumn Title="操作">
                            <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => ViewInterfaceDetails(context))">
                                详情
                            </FluentButton>
                        </TemplateColumn>
                    </FluentDataGrid>
                }
            </FluentCard>

            <!-- Connectivity Test Card -->
            <FluentCard>
                <FluentLabel Typo="Typography.H5">连接测试</FluentLabel>
                <FluentDivider />
                <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="16" Style="margin-top: 16px;">
                    <FluentTextField @bind-Value="testHost" Placeholder="输入主机地址或IP" Style="flex: 1;">
                        <FluentIcon Value="@(new Icons.Regular.Size20.Globe())" Slot="start" />
                    </FluentTextField>
                    <FluentButton Appearance="Appearance.Accent" OnClick="TestConnectivity" Disabled="@isTestingConnectivity">
                        @if (isTestingConnectivity)
                        {
                            <FluentProgressRing Style="width: 16px; height: 16px;" />
                            <span>测试中...</span>
                        }
                        else
                        {
                            <FluentIcon Value="@(new Icons.Regular.Size20.CloudCheckmark())" Slot="start" />
                            <span>测试连接</span>
                        }
                    </FluentButton>
                </FluentStack>
                @if (!string.IsNullOrEmpty(connectivityResult))
                {
                    <FluentMessageBar Intent="@connectivityResultType" Style="margin-top: 12px;">
                        @connectivityResult
                    </FluentMessageBar>
                }
            </FluentCard>
        </FluentStack>
    </div>

    <!-- Interface Details Dialog -->
    @if (selectedInterface != null)
    {
        <FluentDialog @bind-Hidden="@hideDetailsDialog" Modal="true" TrapFocus="true" aria-label="接口详情">
            <FluentDialogHeader>
                <FluentLabel Typo="Typography.H5">@selectedInterface.Name - 详细信息</FluentLabel>
            </FluentDialogHeader>
            <FluentDialogBody>
                <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="12">
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">名称:</FluentLabel>
                        <FluentLabel>@selectedInterface.Name</FluentLabel>
                    </FluentStack>
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">描述:</FluentLabel>
                        <FluentLabel>@selectedInterface.Description</FluentLabel>
                    </FluentStack>
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">类型:</FluentLabel>
                        <FluentLabel>@selectedInterface.Type</FluentLabel>
                    </FluentStack>
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">状态:</FluentLabel>
                        <FluentBadge Appearance="@(selectedInterface.IsUp ? Appearance.Accent : Appearance.Neutral)">
                            @selectedInterface.Status
                        </FluentBadge>
                    </FluentStack>
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">MAC地址:</FluentLabel>
                        <FluentLabel>@selectedInterface.MacAddress</FluentLabel>
                    </FluentStack>
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">速度:</FluentLabel>
                        <FluentLabel>@FormatSpeed(selectedInterface.Speed)</FluentLabel>
                    </FluentStack>
                    <FluentStack Orientation="FluentOrientation.Vertical" VerticalGap="4">
                        <FluentLabel Style="font-weight: bold;">IP地址:</FluentLabel>
                        @foreach (var ip in selectedInterface.IpAddresses)
                        {
                            <FluentLabel Style="margin-left: 16px;">@ip</FluentLabel>
                        }
                    </FluentStack>
                    <FluentDivider />
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">接收流量:</FluentLabel>
                        <FluentLabel>@FormatBytes(selectedInterface.BytesReceived)</FluentLabel>
                    </FluentStack>
                    <FluentStack Orientation="FluentOrientation.Horizontal" VerticalGap="8">
                        <FluentLabel Style="font-weight: bold; min-width: 120px;">发送流量:</FluentLabel>
                        <FluentLabel>@FormatBytes(selectedInterface.BytesSent)</FluentLabel>
                    </FluentStack>
                </FluentStack>
            </FluentDialogBody>
            <FluentDialogFooter>
                <FluentButton Appearance="Appearance.Accent" OnClick="@(() => hideDetailsDialog = true)">
                    关闭
                </FluentButton>
            </FluentDialogFooter>
        </FluentDialog>
    }
}

@code {
    private List<NetworkInterfaceInfo> interfaces = new();
    private NetworkStatistics? statistics;
    private bool isLoading = true;
    private NetworkInterfaceInfo? selectedInterface;
    private bool hideDetailsDialog = true;

    private string testHost = "8.8.8.8";
    private bool isTestingConnectivity = false;
    private string connectivityResult = string.Empty;
    private MessageIntent connectivityResultType = MessageIntent.Info;

    // Chart data
    private ApexChart<ChartDataPoint>? chart;
    private ApexChartOptions<ChartDataPoint> chartOptions = new();
    private System.Timers.Timer? chartTimer;
    private List<ChartDataPoint> receivedDataPoints = new();
    private List<ChartDataPoint> sentDataPoints = new();
    private long lastBytesReceived = 0;
    private long lastBytesSent = 0;
    private const int MaxDataPoints = 60; // Keep 5 minutes of data (60 points * 5 seconds)

    // Chart data model
    public class ChartDataPoint
    {
        public object X { get; set; } = DateTime.Now;
        public decimal Y { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        InitializeChartOptions();
        await LoadData();
        StartChartTimer();
    }

    private void InitializeChartOptions()
    {
        chartOptions = new ApexChartOptions<ChartDataPoint>
        {
            Chart = new Chart
            {
                Toolbar = new Toolbar { Show = false },
                Animations = new Animations { Enabled = true, Easing = Easing.Linear, Speed = 500 }
            },
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels
                {
                    Format = "HH:mm:ss",
                    DatetimeUTC = false
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Labels = new YAxisLabels
                    {
                        Formatter = "function(value) { if (value < 1024) return value.toFixed(0) + ' B/s'; if (value < 1048576) return (value / 1024).toFixed(1) + ' KB/s'; if (value < 1073741824) return (value / 1048576).toFixed(1) + ' MB/s'; return (value / 1073741824).toFixed(1) + ' GB/s'; }"
                    },
                    Title = new AxisTitle { Text = "流量速率" }
                }
            },
            Stroke = new Stroke { Curve = Curve.Smooth, Width = 2 },
            Fill = new Fill
            {
                Type = new List<FillType> { FillType.Gradient },
                Gradient = new FillGradient
                {
                    ShadeIntensity = 1,
                    OpacityFrom = 0.4,
                    OpacityTo = 0.1
                }
            },
            Tooltip = new Tooltip
            {
                X = new TooltipX { Format = "HH:mm:ss" }
            },
            Legend = new Legend { Position = LegendPosition.Top }
        };
    }

    private void StartChartTimer()
    {
        chartTimer = new System.Timers.Timer(5000); // 5 seconds
        chartTimer.Elapsed += async (sender, e) => await UpdateChartData();
        chartTimer.AutoReset = true;
        chartTimer.Start();
    }

    private async Task UpdateChartData()
    {
        try
        {
            var newStats = await NetworkService.GetNetworkStatisticsAsync();
            
            // Calculate traffic rate (bytes per second)
            double receivedRate = 0;
            double sentRate = 0;
            
            if (lastBytesReceived > 0 && newStats.TotalBytesReceived >= lastBytesReceived)
            {
                receivedRate = (newStats.TotalBytesReceived - lastBytesReceived) / 5.0; // 5 second interval
            }
            
            if (lastBytesSent > 0 && newStats.TotalBytesSent >= lastBytesSent)
            {
                sentRate = (newStats.TotalBytesSent - lastBytesSent) / 5.0; // 5 second interval
            }
            
            lastBytesReceived = newStats.TotalBytesReceived;
            lastBytesSent = newStats.TotalBytesSent;
            
            // Add new data points
            var currentTime = DateTime.Now;
            receivedDataPoints.Add(new ChartDataPoint { X = currentTime, Y = (decimal)receivedRate });
            sentDataPoints.Add(new ChartDataPoint { X = currentTime, Y = (decimal)sentRate });
            
            // Keep only last MaxDataPoints
            if (receivedDataPoints.Count > MaxDataPoints)
            {
                receivedDataPoints.RemoveAt(0);
                sentDataPoints.RemoveAt(0);
            }
            
            // Update statistics
            statistics = newStats;
            
            await InvokeAsync(async () =>
            {
                StateHasChanged();
                if (chart != null)
                {
                    await chart.UpdateSeriesAsync(true);
                }
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating chart data: {ex.Message}");
        }
    }

    public void Dispose()
    {
        chartTimer?.Stop();
        chartTimer?.Dispose();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            interfaces = await NetworkService.GetAllNetworkInterfacesAsync();
            statistics = await NetworkService.GetNetworkStatisticsAsync();
        }
        catch (Exception ex)
        {
            ToastService.ShowError("加载网络信息失败: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        ToastService.ShowSuccess("数据已刷新");
    }

    private void ViewInterfaceDetails(NetworkInterfaceInfo interfaceInfo)
    {
        selectedInterface = interfaceInfo;
        hideDetailsDialog = false;
    }

    private async Task TestConnectivity()
    {
        if (string.IsNullOrWhiteSpace(testHost))
        {
            ToastService.ShowWarning("请输入要测试的主机地址");
            return;
        }

        isTestingConnectivity = true;
        connectivityResult = string.Empty;

        try
        {
            var success = await NetworkService.TestConnectivityAsync(testHost);
            if (success)
            {
                connectivityResult = $"连接到 {testHost} 成功";
                connectivityResultType = MessageIntent.Success;
            }
            else
            {
                connectivityResult = $"无法连接到 {testHost}";
                connectivityResultType = MessageIntent.Error;
            }
        }
        catch (Exception ex)
        {
            connectivityResult = $"测试失败: {ex.Message}";
            connectivityResultType = MessageIntent.Error;
        }
        finally
        {
            isTestingConnectivity = false;
        }
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string FormatSpeed(long bitsPerSecond)
    {
        string[] sizes = { "bps", "Kbps", "Mbps", "Gbps" };
        double speed = bitsPerSecond;
        int order = 0;
        while (speed >= 1000 && order < sizes.Length - 1)
        {
            order++;
            speed = speed / 1000;
        }
        return $"{speed:0.##} {sizes[order]}";
    }
}
