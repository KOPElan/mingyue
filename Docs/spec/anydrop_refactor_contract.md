## Anydrop 重构契约说明（2026版）

### 一、重构目标
将Anydrop重构为高内聚、低耦合、易维护、可扩展的现代化对话与文件快传系统，全面支持PRD中定义的多媒体、异步、检索、API等功能，提升性能、体验和可测试性。

### 二、重构范围
- MingYue项目中Anydrop相关的前端组件、服务、数据模型、API接口及与后端的交互。
- 涉及消息、文件、媒体、检索、API、认证等全链路。

### 三、重构原则
1. **分层解耦**：UI、状态管理、业务逻辑、数据访问分层，职责单一，便于维护和测试。
2. **现代状态管理**：采用StateContainer/Fluxor等集中管理消息、检索、选中项等状态。
3. **异步与并发安全**：所有异步操作支持取消，UI不阻塞，防止内存泄漏。
4. **性能与体验优化**：支持分页、虚拟滚动、缩略图懒加载、异步上传、检索高效。
5. **命名与规范**：统一命名风格，Magic String/Number提取为常量或配置，注释清晰。
6. **异常与资源管理**：细化异常处理，完善资源释放，用户提示友好。
7. **安全性提升**：前后端严格校验文件类型、大小、路径，防止恶意操作。
8. **API设计**：RESTful风格，支持APP等多终端扩展，接口文档完善。
9. **可测试性**：业务逻辑抽离到服务层，UI与逻辑分离，具备单元和组件测试。

### 四、关键重构任务
1. 拆分Anydrop.razor为UI、code-behind、服务类，按功能模块化（如消息、文件、媒体、检索、API）。
2. 引入现代状态管理容器，集中管理所有对话、检索、选中项等状态。
3. 优化消息和文件加载为分页/虚拟滚动，支持大数据量高性能渲染。
4. 多媒体/大文件异步上传，上传队列、进度、失败重试、断点续传。
5. 超链接meta解析，前后端协作，卡片式展示。
6. 多媒体/文件独立选项卡浏览，缩略图懒加载，支持批量操作。
7. 检索与定位：全文检索、上下文高亮、跳转定位、性能优化。
8. API接口重构，RESTful风格，支持分页、筛选、检索、权限。
9. 统一命名、Magic String/Number提取、注释与文档完善。
10. 细化异常类型，前后端安全校验，用户友好提示。
11. 业务逻辑抽离，单元测试、bUnit组件测试覆盖关键路径。

### 五、验收标准
- 代码结构清晰，分层合理，职责分明，符合SOLID原则。
- 状态管理集中，UI与业务逻辑彻底解耦。
- 支持大数据量和多媒体下的高性能渲染与异步体验。
- 关键路径具备单元测试和组件测试覆盖。
- 文件上传/下载/检索/多媒体/API等功能通过集成测试。
- 代码风格、命名、注释、文档符合项目规范。
- 安全性、健壮性、用户体验均达到PRD和技术债文档要求。