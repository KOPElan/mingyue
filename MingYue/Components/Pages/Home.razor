@page "/"
@using MingYue.Models
@using MingYue.Services
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject ISystemMonitorService SystemMonitorService
@inject IApplicationService ApplicationService
@inject IDockItemService DockItemService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>MingYue - Home Server Portal</PageTitle>

<div class="home-page">
    <!-- Background Effects -->
    <div class="home-bg-effects">
        <div class="bg-gradient-blob bg-gradient-blob-1"></div>
        <div class="bg-gradient-blob bg-gradient-blob-2"></div>
        <div class="bg-gradient-blob bg-gradient-blob-3"></div>
        <div class="bg-grid-pattern"></div>
    </div>

    <!-- Main Content Container -->
    <div class="home-content">
        <!-- Header -->
        <div class="home-header">
            <div class="home-header-left">
                <div class="home-logo">
                    <FluentIcon Value="@(new Icons.Regular.Size24.GridDots())" Color="Color.Accent" />
                </div>
                <div class="home-title">
                    <div class="home-title-main">My Portal</div>
                    <div class="home-title-sub">Home Server</div>
                </div>
            </div>
            <div class="home-header-right">
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true" @onclick="@(() => Navigation.NavigateTo("/app-management"))">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Search())" />
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" IconOnly="true">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Settings())" />
                </FluentButton>
                <div class="home-user-avatar"></div>
            </div>
        </div>

        <!-- Clock Section -->
        <div class="home-clock-section">
            <div class="home-clock">@TimeNow</div>
            <div class="home-date">@DateNow</div>
        </div>

        <!-- Info Cards -->
        <div class="home-info-cards">
            <!-- Weather Card (placeholder for now) -->
            <div class="info-card info-card-weather">
                <div class="info-card-glow weather-glow"></div>
                <div class="info-card-content">
                    <div class="info-card-header">
                        <span class="info-card-label">天气</span>
                        <div class="info-card-icon weather-icon">
                            <FluentIcon Value="@(new Icons.Regular.Size24.WeatherSunny())" Color="Color.Custom" CustomColor="#facc15" />
                        </div>
                    </div>
                    <div class="weather-temp">18°</div>
                    <div class="weather-condition">晴朗</div>
                    <div class="weather-range">最高 22° / 最低 14°</div>
                </div>
            </div>

            <!-- System Monitor Card -->
            <div class="info-card info-card-system">
                <div class="info-card-glow system-glow"></div>
                <div class="info-card-content">
                    <div class="info-card-header">
                        <span class="info-card-label">系统监控</span>
                        <FluentIcon Value="@(new Icons.Regular.Size20.Server())" />
                    </div>
                    <div class="system-stats">
                        <div class="stat-item">
                            <div class="stat-row">
                                <span class="stat-label">CPU</span>
                                <span class="stat-value stat-value-cyan">@systemInfo.Cpu.UsagePercent.ToString("F0")%</span>
                            </div>
                            <div class="stat-bar">
                                <div class="stat-bar-fill stat-bar-cyan" style="width: @systemInfo.Cpu.UsagePercent%"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-row">
                                <span class="stat-label">RAM</span>
                                <span class="stat-value stat-value-purple">@systemInfo.Memory.UsedGB</span>
                            </div>
                            <div class="stat-bar">
                                <div class="stat-bar-fill stat-bar-purple" style="width: @systemInfo.Memory.UsagePercent%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network Status Card -->
            <div class="info-card info-card-network">
                <div class="info-card-glow network-glow"></div>
                <div class="info-card-content">
                    <div class="info-card-header">
                        <span class="info-card-label">网络状态</span>
                        <div class="network-indicator"></div>
                    </div>
                    <div class="network-stats">
                        <div class="network-stat-item">
                            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowDownload())" Color="Color.Custom" CustomColor="#22c55e" />
                            <div class="network-stat-value">@downloadSpeed</div>
                            <div class="network-stat-unit">MB/S</div>
                        </div>
                        <div class="network-stat-item">
                            <FluentIcon Value="@(new Icons.Regular.Size20.ArrowUpload())" Color="Color.Custom" CustomColor="#60a5fa" />
                            <div class="network-stat-value">@uploadSpeed</div>
                            <div class="network-stat-unit">MB/S</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications Section -->
        <div class="home-applications">
            <div class="home-section-header">
                <h2 class="home-section-title">应用程序</h2>
                <FluentAnchor Href="/app-management" Appearance="Appearance.Lightweight" class="view-all-link">查看全部</FluentAnchor>
            </div>
            <div class="app-grid">
                @foreach (var app in visibleApplications)
                {
                    <a href="@app.Url" class="app-card" target="_blank">
                        <div class="app-icon" style="background: @GetAppGradient(app.IconColor)">
                            @if (!string.IsNullOrEmpty(app.Icon))
                            {
                                <FluentIcon Value="@GetIcon(app.Icon)" />
                            }
                            else
                            {
                                <FluentIcon Value="@(new Icons.Regular.Size24.Apps())" />
                            }
                        </div>
                        <div class="app-info">
                            <div class="app-title">@app.Title</div>
                            <div class="app-category">@app.Category</div>
                        </div>
                    </a>
                }
                <button class="app-card app-card-add" @onclick="@(() => Navigation.NavigateTo("/app-management"))">
                    <div class="app-icon app-icon-add">
                        <FluentIcon Value="@(new Icons.Regular.Size24.Add())" />
                    </div>
                    <div class="app-info">
                        <div class="app-title">添加</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Dock -->
    <div class="home-dock">
        <div class="dock-container">
            @foreach (var item in dockItems.Take(4))
            {
                <a href="@item.Url" class="dock-item" title="@item.Title">
                    @if (!string.IsNullOrEmpty(item.Icon))
                    {
                        <FluentIcon Value="@GetIcon(item.Icon)" />
                    }
                    else
                    {
                        <FluentIcon Value="@(new Icons.Regular.Size24.Apps())" />
                    }
                    <div class="dock-tooltip">@item.Title</div>
                </a>
            }
        </div>
    </div>
</div>

@code {
    private string TimeNow => DateTime.Now.ToString("HH:mm");
    private string DateNow => DateTime.Now.ToString("yyyy年MM月dd日, 星期") + GetDayOfWeek();
    private SystemResourceInfo systemInfo = new();
    private List<Application> visibleApplications = new();
    private List<DockItem> dockItems = new();
    private System.Threading.Timer? updateTimer;
    private int downloadSpeed = 24;
    private int uploadSpeed = 12;
    private static readonly Random _random = new Random();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
        
        // Update time and system info every 3 seconds
        updateTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadSystemInfoAsync();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private async Task LoadDataAsync()
    {
        await Task.WhenAll(
            LoadSystemInfoAsync(),
            LoadApplicationsAsync(),
            LoadDockItemsAsync()
        );
    }

    private async Task LoadSystemInfoAsync()
    {
        try
        {
            systemInfo = await SystemMonitorService.GetSystemResourceInfoAsync();
            
            // TODO: Implement proper network speed calculation with delta between time intervals
            // This is placeholder logic for demonstration purposes
            if (systemInfo.Networks.Any())
            {
                var mainNetwork = systemInfo.Networks.First();
                downloadSpeed = (int)(mainNetwork.BytesReceived / 1024.0 / 1024.0 % 100);
                uploadSpeed = (int)(mainNetwork.BytesSent / 1024.0 / 1024.0 % 100);
            }
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private async Task LoadApplicationsAsync()
    {
        try
        {
            var allApps = await ApplicationService.GetAllApplicationsAsync();
            visibleApplications = allApps.Where(a => a.IsVisible).Take(8).ToList();
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private async Task LoadDockItemsAsync()
    {
        try
        {
            dockItems = await DockItemService.GetAllDockItemsAsync();
        }
        catch (Exception)
        {
            // Handle exception
        }
    }

    private string GetDayOfWeek()
    {
        return DateTime.Now.DayOfWeek switch
        {
            DayOfWeek.Monday => "一",
            DayOfWeek.Tuesday => "二",
            DayOfWeek.Wednesday => "三",
            DayOfWeek.Thursday => "四",
            DayOfWeek.Friday => "五",
            DayOfWeek.Saturday => "六",
            DayOfWeek.Sunday => "日",
            _ => ""
        };
    }

    private string GetAppGradient(string? iconColor)
    {
        if (string.IsNullOrEmpty(iconColor))
        {
            // Default gradients for variety
            var gradients = new[]
            {
                "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
                "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",
                "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
                "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)"
            };
            return gradients[_random.Next(gradients.Length)];
        }
        return $"linear-gradient(135deg, {iconColor} 0%, {iconColor}dd 100%)";
    }

    private Icon GetIcon(string iconName)
    {
        // TODO: Implement icon mapping based on iconName parameter
        // For now, return default icon - icon mapping can be added based on application requirements
        return new Icons.Regular.Size24.Apps();
    }

    public void Dispose()
    {
        updateTimer?.Dispose();
    }
}