@inherits LayoutComponentBase
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@using MingYue.Components.Dialog
@using MingYue.Models
@using MingYue.Services
@inject IDialogService DialogService
@inject AuthenticationStateService AuthStateService
@inject NavigationManager Navigation
@implements IDisposable

<FluentDesignTheme @bind-Mode="@Settings.Mode" @bind-OfficeColor="@Settings.OfficeColor" StorageName="theme" />

@if (IsHomePage)
{
    <!-- Home page with custom layout -->
    @Body
}
else
{
    <!-- Standard layout for other pages -->
    <FluentMainLayout>
        <Header>
            <FluentStack>
                æ˜Žæœˆ Portal
            </FluentStack>
            <FluentSpacer />
            <FluentStack HorizontalAlignment="HorizontalAlignment.Right" VerticalGap="10">
                @if (AuthStateService.IsAuthenticated && AuthStateService.CurrentUser != null)
                {
                    <FluentLabel>@AuthStateService.CurrentUser.Username</FluentLabel>
                    @if (AuthStateService.IsAdmin)
                    {
                        <FluentBadge Fill="success" BackgroundColor="green" Color="white">Admin</FluentBadge>
                    }
                    <FluentButton Appearance="Appearance.Lightweight" OnClick="Logout" Title="Logout">
                        <FluentIcon Value="@(new Icons.Regular.Size20.SignOut())" />
                    </FluentButton>
                }
                <FluentIcon Value="@(new Icons.Regular.Size20.Alert())" Color="@Color.Fill"></FluentIcon>
                <FluentIcon Value="@(new Icons.Regular.Size20.Settings())" Color="@Color.Fill" Title="è®¾ç½®" @onclick="OpenSetting" />
            </FluentStack>
        </Header>
        <Body>
            @Body
        </Body>
    </FluentMainLayout>
}

<FluentToastProvider />
<FluentDialogProvider />
<FluentTooltipProvider />
<FluentMessageBarProvider />
<FluentMenuProvider />
<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    public SettingModel Settings { get; set; } = new();
    private string _currentPath = "";
    private bool IsHomePage => _currentPath == "" || _currentPath == "/";

    protected override void OnInitialized()
    {
        AuthStateService.OnAuthenticationStateChanged += StateHasChanged;
        Navigation.LocationChanged += OnLocationChanged;
        UpdateCurrentPath();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateCurrentPath();
        StateHasChanged();
    }

    private void UpdateCurrentPath()
    {
        _currentPath = Navigation.ToBaseRelativePath(Navigation.Uri);
    }

    public async Task OpenSetting()
    {
        IDialogReference? _dialog;
        _dialog = await DialogService.ShowPanelAsync<SettingDialog>(Settings, new DialogParameters<SettingModel>()
        {
            Content = Settings,
            Alignment = HorizontalAlignment.Right,
            Title = $"Hello",
        });
        _ = await _dialog.Result;
        // HandlePanel(result);
    }

    private async Task Logout()
    {
        await AuthStateService.LogoutAsync();
        Navigation.NavigateTo("/login", true);
    }

    public void Dispose()
    {
        AuthStateService.OnAuthenticationStateChanged -= StateHasChanged;
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
