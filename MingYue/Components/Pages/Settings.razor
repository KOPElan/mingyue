@page "/settings"
@using MingYue.Models
@using MingYue.Services
@using MingYue.Resources
@using Microsoft.Extensions.Localization
@using System.Text.Json
@inject ISystemSettingService SettingService
@inject ILocalizationService LocalizationService
@inject AuthenticationStateService AuthStateService
@inject NavigationManager Navigation
@inject ILogger<Settings> Logger
@inject IToastService ToastService
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["SystemSettings"] - MingYue</PageTitle>

@if (!isAuthorized)
{
    <FluentMessageBar Intent="MessageIntent.Error">
        <p>@Localizer["AccessDenied"]</p>
    </FluentMessageBar>
    return;
}

<FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
        <h2 style="margin: 0;">@Localizer["SystemSettings"]</h2>
        <FluentSpacer />
        <FluentButton Appearance="Appearance.Neutral" OnClick="@OpenImportDialog">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowDownload())" />
            @Localizer["ImportSettings"]
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@ExportSettings">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowUpload())" />
            @Localizer["ExportSettings"]
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@OpenResetDialog">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size20.ArrowReset())" />
            @Localizer["ResetToDefault"]
        </FluentButton>
    </FluentStack>

    @if (isLoading)
    {
        <FluentProgressRing />
    }
    else
    {
        <FluentAccordion>
            <!-- 常规设置 -->
            <FluentAccordionItem Heading="@Localizer["GeneralSettings"]" Expanded="true">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["Language"]</FluentLabel>
                            <FluentSelect 
                                TOption="MingYue.Services.CultureInfo"
                                Items="@availableCultures"
                                @bind-SelectedOption="@selectedCulture"
                                @bind-SelectedOption:after="@OnLanguageChanged"
                                OptionValue="@(c => c.Code)"
                                OptionText="@(c => c.DisplayName)"
                                Style="width: 100%; max-width: 300px;" />
                            <FluentLabel Typo="Typography.Body" Style="font-size: 12px; color: var(--neutral-foreground-hint);">
                                @Localizer["LanguageChangeHint"]
                            </FluentLabel>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["TimeZone"]</FluentLabel>
                            <FluentTextField 
                                @bind-Value="@generalSettings.TimeZone"
                                Style="width: 100%; max-width: 300px;" 
                                Placeholder="Asia/Shanghai" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("system.timezone", generalSettings.TimeZone, Localizer["GeneralSettings"], Localizer["TimeZone"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["SystemName"]</FluentLabel>
                            <FluentTextField 
                                @bind-Value="@generalSettings.SystemName"
                                Style="width: 100%; max-width: 300px;" 
                                Placeholder="MingYue" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("system.name", generalSettings.SystemName, Localizer["GeneralSettings"], Localizer["SystemName"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>
                </FluentStack>
            </FluentAccordionItem>

            <!-- 外观设置 -->
            <FluentAccordionItem Heading="@Localizer["AppearanceSettings"]">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["ThemeMode"]</FluentLabel>
                            <FluentSelect 
                                TOption="string"
                                @bind-Value="@appearanceSettings.ThemeMode"
                                @bind-Value:after="@(() => SaveSettingAsync("theme.mode", appearanceSettings.ThemeMode, Localizer["AppearanceSettings"], Localizer["ThemeMode"]))"
                                Items="@themeModeOptions"
                                OptionValue="@(i => i)"
                                OptionText="@(i => i == "light" ? Localizer["Light"] : i == "dark" ? Localizer["Dark"] : Localizer["Auto"])"
                                Style="width: 100%; max-width: 300px;" />
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["AccentColor"]</FluentLabel>
                            <FluentTextField 
                                @bind-Value="@appearanceSettings.AccentColor"
                                Style="width: 100%; max-width: 300px;" 
                                Placeholder="#0078d4" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("theme.accentColor", appearanceSettings.AccentColor, Localizer["AppearanceSettings"], Localizer["AccentColor"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["BorderRadius"]</FluentLabel>
                            <FluentNumberField 
                                @bind-Value="@appearanceSettings.BorderRadius"
                                Min="0"
                                Max="20"
                                Style="width: 100%; max-width: 300px;" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("theme.borderRadius", appearanceSettings.BorderRadius.ToString(), Localizer["AppearanceSettings"], Localizer["BorderRadius"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>
                </FluentStack>
            </FluentAccordionItem>

            <!-- 安全设置 -->
            <FluentAccordionItem Heading="@Localizer["SecuritySettings"]">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["SessionTimeout"]</FluentLabel>
                            <FluentNumberField 
                                @bind-Value="@securitySettings.SessionTimeout"
                                Min="5"
                                Max="1440"
                                Style="width: 100%; max-width: 300px;" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("security.sessionTimeout", securitySettings.SessionTimeout.ToString(), Localizer["SecuritySettings"], Localizer["SessionTimeout"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["PasswordPolicy"]</FluentLabel>
                            <FluentCheckbox 
                                @bind-Value="@securitySettings.RequireStrongPassword"
                                @bind-Value:after="@(() => SaveSettingAsync("security.requireStrongPassword", securitySettings.RequireStrongPassword.ToString().ToLower(), Localizer["SecuritySettings"], Localizer["PasswordPolicy"]))"
                                Label="@Localizer["RequireStrongPassword"]" />
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["MinPasswordLength"]</FluentLabel>
                            <FluentNumberField 
                                @bind-Value="@securitySettings.MinPasswordLength"
                                Min="6"
                                Max="32"
                                Style="width: 100%; max-width: 300px;" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("security.minPasswordLength", securitySettings.MinPasswordLength.ToString(), Localizer["SecuritySettings"], Localizer["MinPasswordLength"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["LoginLockout"]</FluentLabel>
                            <FluentCheckbox 
                                @bind-Value="@securitySettings.EnableLoginLockout"
                                @bind-Value:after="@(() => SaveSettingAsync("security.enableLoginLockout", securitySettings.EnableLoginLockout.ToString().ToLower(), Localizer["SecuritySettings"], Localizer["LoginLockout"]))"
                                Label="@Localizer["EnableLoginLockout"]" />
                        </FluentStack>
                    </FluentCard>
                </FluentStack>
            </FluentAccordionItem>

            <!-- 文件管理设置 -->
            <FluentAccordionItem Heading="@Localizer["FileManagementSettings"]">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["MaxFileSizeMB"]</FluentLabel>
                            <FluentNumberField 
                                @bind-Value="@fileSettings.MaxUploadSize"
                                Min="1"
                                Max="10240"
                                Style="width: 100%; max-width: 300px;" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("filemanager.maxUploadSize", fileSettings.MaxUploadSize.ToString(), Localizer["FileManagementSettings"], Localizer["MaxFileSizeMB"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["DefaultPath"]</FluentLabel>
                            <FluentTextField 
                                @bind-Value="@fileSettings.DefaultPath"
                                Style="width: 100%; max-width: 500px;" 
                                Placeholder="/data" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("filemanager.defaultPath", fileSettings.DefaultPath, Localizer["FileManagementSettings"], Localizer["DefaultPath"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["ShowHiddenFiles"]</FluentLabel>
                            <FluentCheckbox 
                                @bind-Value="@fileSettings.ShowHiddenFiles"
                                @bind-Value:after="@(() => SaveSettingAsync("filemanager.showHiddenFiles", fileSettings.ShowHiddenFiles.ToString().ToLower(), Localizer["FileManagementSettings"], Localizer["ShowHiddenFiles"]))"
                                Label="@Localizer["ShowHiddenFiles"]" />
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["AllowedExtensions"]</FluentLabel>
                            <FluentTextField 
                                @bind-Value="@fileSettings.AllowedFileTypes"
                                Style="width: 100%; max-width: 500px;" 
                                Placeholder="@Localizer["AllowedExtensionsPlaceholder"]" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("filemanager.allowedFileTypes", fileSettings.AllowedFileTypes, Localizer["FileManagementSettings"], Localizer["AllowedExtensions"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>
                </FluentStack>
            </FluentAccordionItem>

            <!-- Docker设置 -->
            <FluentAccordionItem Heading="@Localizer["DockerSettings"]">
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["DockerHost"]</FluentLabel>
                            <FluentTextField 
                                @bind-Value="@dockerSettings.DockerHost"
                                Style="width: 100%; max-width: 500px;" 
                                Placeholder="unix:///var/run/docker.sock" />
                            <FluentLabel Typo="Typography.Body" Style="font-size: 12px; color: var(--neutral-foreground-hint);">
                                @Localizer["DockerHostHint"]
                            </FluentLabel>
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("docker.host", dockerSettings.DockerHost, Localizer["DockerSettings"], Localizer["DockerHost"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["DockerApiVersion"]</FluentLabel>
                            <FluentTextField 
                                @bind-Value="@dockerSettings.ApiVersion"
                                Style="width: 100%; max-width: 300px;" 
                                Placeholder="1.43" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("docker.apiVersion", dockerSettings.ApiVersion, Localizer["DockerSettings"], Localizer["DockerApiVersion"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["AutoUpdateContainers"]</FluentLabel>
                            <FluentCheckbox 
                                @bind-Value="@dockerSettings.AutoUpdateContainers"
                                @bind-Value:after="@(() => SaveSettingAsync("docker.autoUpdateContainers", dockerSettings.AutoUpdateContainers.ToString().ToLower(), Localizer["DockerSettings"], Localizer["AutoUpdateContainers"]))"
                                Label="@Localizer["EnableAutoUpdateCheck"]" />
                        </FluentStack>
                    </FluentCard>

                    <FluentCard>
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                            <FluentLabel Typo="Typography.Body" Weight="FontWeight.Bold">@Localizer["ContainerLogMaxLines"]</FluentLabel>
                            <FluentNumberField 
                                @bind-Value="@dockerSettings.LogMaxLines"
                                Min="100"
                                Max="10000"
                                Style="width: 100%; max-width: 300px;" />
                            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => SaveSettingAsync("docker.logMaxLines", dockerSettings.LogMaxLines.ToString(), Localizer["DockerSettings"], Localizer["ContainerLogMaxLines"]))">
                                @Localizer["Save"]
                            </FluentButton>
                        </FluentStack>
                    </FluentCard>
                </FluentStack>
            </FluentAccordionItem>
        </FluentAccordion>
    }
</FluentStack>

<!-- 导入设置对话框 -->
<FluentDialog @ref="importDialog" @bind-Hidden="@isImportDialogHidden" TrapFocus="true" Modal="true">
    <FluentDialogHeader ShowDismiss="true">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.ArrowDownload())" />
            <FluentLabel Typo="Typography.PaneHeader">@Localizer["ImportSettings"]</FluentLabel>
        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
            <FluentLabel Typo="Typography.Body">
                @Localizer["PasteJsonContent"]
            </FluentLabel>
            <FluentTextArea 
                @bind-Value="@importJson"
                Rows="15"
                Style="width: 100%; font-family: monospace; font-size: 12px;" 
                Placeholder="@Localizer["PasteJsonPlaceholder"]" />
        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@ImportSettings">
            @Localizer["Import"]
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CloseImportDialog">
            @Localizer["Cancel"]
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

<!-- 重置确认对话框 -->
<FluentDialog @ref="resetDialog" @bind-Hidden="@isResetDialogHidden" TrapFocus="true" Modal="true">
    <FluentDialogHeader ShowDismiss="true">
        <FluentStack VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Microsoft.FluentUI.AspNetCore.Components.Icons.Regular.Size24.Warning())" Color="Color.Error" />
            <FluentLabel Typo="Typography.PaneHeader">@Localizer["ResetConfirmTitle"]</FluentLabel>
        </FluentStack>
    </FluentDialogHeader>

    <FluentDialogBody>
        <FluentMessageBar Intent="MessageIntent.Warning">
            <p>@Localizer["ResetConfirmMessage"]</p>
        </FluentMessageBar>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" OnClick="@ResetSettings">
            @Localizer["ConfirmReset"]
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CloseResetDialog">
            @Localizer["Cancel"]
        </FluentButton>
    </FluentDialogFooter>
</FluentDialog>

@code {
    private bool isAuthorized = false;
    private bool isLoading = true;
    private bool isImportDialogHidden = true;
    private bool isResetDialogHidden = true;
    private string importJson = string.Empty;

    private FluentDialog? importDialog;
    private FluentDialog? resetDialog;

    // Settings models
    private GeneralSettings generalSettings = new();
    private AppearanceSettings appearanceSettings = new();
    private SecuritySettings securitySettings = new();
    private FileSettings fileSettings = new();
    private DockerSettings dockerSettings = new();

    // Localization
    private List<MingYue.Services.CultureInfo> availableCultures = new();
    private MingYue.Services.CultureInfo? selectedCulture;

    // Options for select dropdowns
    private List<string> themeModeOptions = new() { "light", "dark", "auto" };

    protected override async Task OnInitializedAsync()
    {
        if (!AuthStateService.IsAdmin)
        {
            isAuthorized = false;
            Logger.LogWarning("Non-admin user {Username} attempted to access settings", 
                AuthStateService.CurrentUser?.Username);
            return;
        }

        isAuthorized = true;
        
        // Load available cultures
        availableCultures = LocalizationService.GetAvailableCultures();
        var currentCulture = LocalizationService.GetCurrentCulture();
        selectedCulture = availableCultures.FirstOrDefault(c => c.Code == currentCulture);
        
        await LoadAllSettings();
    }

    private async Task LoadAllSettings()
    {
        isLoading = true;
        try
        {
            // Load general settings
            generalSettings.TimeZone = await SettingService.GetSettingValueAsync("system.timezone", "Asia/Shanghai") ?? "Asia/Shanghai";
            generalSettings.SystemName = await SettingService.GetSettingValueAsync("system.name", "MingYue") ?? "MingYue";

            // Load appearance settings
            appearanceSettings.ThemeMode = await SettingService.GetSettingValueAsync("theme.mode", "auto") ?? "auto";
            appearanceSettings.AccentColor = await SettingService.GetSettingValueAsync("theme.accentColor", "#0078d4") ?? "#0078d4";
            var borderRadiusStr = await SettingService.GetSettingValueAsync("theme.borderRadius", "4");
            appearanceSettings.BorderRadius = int.TryParse(borderRadiusStr, out var br) ? br : 4;

            // Load security settings
            var sessionTimeoutStr = await SettingService.GetSettingValueAsync("security.sessionTimeout", "30");
            securitySettings.SessionTimeout = int.TryParse(sessionTimeoutStr, out var st) ? st : 30;
            
            var requireStrongPasswordStr = await SettingService.GetSettingValueAsync("security.requireStrongPassword", "true");
            securitySettings.RequireStrongPassword = bool.TryParse(requireStrongPasswordStr, out var rsp) && rsp;
            
            var minPasswordLengthStr = await SettingService.GetSettingValueAsync("security.minPasswordLength", "8");
            securitySettings.MinPasswordLength = int.TryParse(minPasswordLengthStr, out var mpl) ? mpl : 8;
            
            var enableLoginLockoutStr = await SettingService.GetSettingValueAsync("security.enableLoginLockout", "true");
            securitySettings.EnableLoginLockout = bool.TryParse(enableLoginLockoutStr, out var ell) && ell;

            // Load file settings
            var maxUploadSizeStr = await SettingService.GetSettingValueAsync("filemanager.maxUploadSize", "100");
            fileSettings.MaxUploadSize = int.TryParse(maxUploadSizeStr, out var mus) ? mus : 100;
            
            fileSettings.DefaultPath = await SettingService.GetSettingValueAsync("filemanager.defaultPath", "/data") ?? "/data";
            
            var showHiddenFilesStr = await SettingService.GetSettingValueAsync("filemanager.showHiddenFiles", "false");
            fileSettings.ShowHiddenFiles = bool.TryParse(showHiddenFilesStr, out var shf) && shf;
            
            fileSettings.AllowedFileTypes = await SettingService.GetSettingValueAsync("filemanager.allowedFileTypes", "") ?? "";

            // Load docker settings
            dockerSettings.DockerHost = await SettingService.GetSettingValueAsync("docker.host", "unix:///var/run/docker.sock") ?? "unix:///var/run/docker.sock";
            dockerSettings.ApiVersion = await SettingService.GetSettingValueAsync("docker.apiVersion", "1.43") ?? "1.43";
            
            var autoUpdateContainersStr = await SettingService.GetSettingValueAsync("docker.autoUpdateContainers", "false");
            dockerSettings.AutoUpdateContainers = bool.TryParse(autoUpdateContainersStr, out var auc) && auc;
            
            var logMaxLinesStr = await SettingService.GetSettingValueAsync("docker.logMaxLines", "1000");
            dockerSettings.LogMaxLines = int.TryParse(logMaxLinesStr, out var lml) ? lml : 1000;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading settings");
            ToastService.ShowError(Localizer["LoadSettingsFailed"]);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettingAsync(string key, string value, string category, string description)
    {
        try
        {
            await SettingService.SetSettingAsync(key, value, category, description);
            ToastService.ShowSuccess(Localizer["SettingsSaved"]);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving setting {Key}", key);
            ToastService.ShowError(Localizer["SaveSettingsFailed"]);
        }
    }

    private async Task OnLanguageChanged()
    {
        if (selectedCulture == null) return;
        
        try
        {
            // Save the language setting to database
            await LocalizationService.SetCultureAsync(selectedCulture.Code);
            
            // Navigate to the culture controller to set the cookie and redirect back
            // This ensures the RequestLocalizationMiddleware picks up the new culture
            var redirectUri = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/api/Culture/set?culture={selectedCulture.Code}&redirectUri={redirectUri}", forceLoad: true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing language");
            ToastService.ShowError(Localizer["LanguageChangeFailed"]);
        }
    }

    private async Task ExportSettings()
    {
        try
        {
            var json = await SettingService.ExportSettingsAsync();
            
            // Download the JSON file
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var base64 = Convert.ToBase64String(bytes);
            var fileName = $"mingyue-settings-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
            
            ToastService.ShowSuccess(Localizer["SettingsExported"]);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting settings");
            ToastService.ShowError(Localizer["ExportSettingsFailed"]);
        }
    }

    private void OpenImportDialog()
    {
        importJson = string.Empty;
        isImportDialogHidden = false;
    }

    private async Task ImportSettings()
    {
        if (string.IsNullOrWhiteSpace(importJson))
        {
            ToastService.ShowWarning(Localizer["PleaseEnterJson"]);
            return;
        }

        try
        {
            // Validate JSON
            JsonDocument.Parse(importJson);
            
            await SettingService.ImportSettingsAsync(importJson);
            ToastService.ShowSuccess(Localizer["SettingsImported"]);
            
            CloseImportDialog();
            await LoadAllSettings();
        }
        catch (JsonException)
        {
            ToastService.ShowError(Localizer["InvalidJsonFormat"]);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error importing settings");
            ToastService.ShowError(Localizer["ImportSettingsFailed"]);
        }
    }

    private void CloseImportDialog()
    {
        isImportDialogHidden = true;
        importJson = string.Empty;
    }

    private void OpenResetDialog()
    {
        isResetDialogHidden = false;
    }

    private async Task ResetSettings()
    {
        try
        {
            // Delete all settings using a bulk operation for better performance
            await SettingService.DeleteAllSettingsAsync();
            
            ToastService.ShowSuccess(Localizer["SettingsResetSuccess"]);
            
            CloseResetDialog();
            await LoadAllSettings();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error resetting settings");
            ToastService.ShowError(Localizer["ResetSettingsFailed"]);
        }
    }

    private void CloseResetDialog()
    {
        isResetDialogHidden = true;
    }

    // Settings classes
    private class GeneralSettings
    {
        public string TimeZone { get; set; } = "Asia/Shanghai";
        public string SystemName { get; set; } = "MingYue";
    }

    private class AppearanceSettings
    {
        public string ThemeMode { get; set; } = "auto";
        public string AccentColor { get; set; } = "#0078d4";
        public int BorderRadius { get; set; } = 4;
    }

    private class SecuritySettings
    {
        public int SessionTimeout { get; set; } = 30;
        public bool RequireStrongPassword { get; set; } = true;
        public int MinPasswordLength { get; set; } = 8;
        public bool EnableLoginLockout { get; set; } = true;
    }

    private class FileSettings
    {
        public int MaxUploadSize { get; set; } = 100;
        public string DefaultPath { get; set; } = "/data";
        public bool ShowHiddenFiles { get; set; } = false;
        public string AllowedFileTypes { get; set; } = "";
    }

    private class DockerSettings
    {
        public string DockerHost { get; set; } = "unix:///var/run/docker.sock";
        public string ApiVersion { get; set; } = "1.43";
        public bool AutoUpdateContainers { get; set; } = false;
        public int LogMaxLines { get; set; } = 1000;
    }
}
